<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABG 酸鹼判讀與病因分析</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX compilation -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; }
        /* 隱藏數字輸入框的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 核心醫療邏輯與圖表常數 ---
        // 這些常數用於將圖片上的座標映射到實際的 pH 與 HCO3 值
        const GRAPH_X_MIN = 7.0;
        const GRAPH_X_MAX = 7.8;
        const GRAPH_Y_MIN = 0;
        const GRAPH_Y_MAX = 60;

        // 根據您提供的圖片推算的網格邊界百分比 (可微調)
        const IMG_X_MIN_PCT = 0.138; 
        const IMG_X_MAX_PCT = 0.941; 
        const IMG_Y_MIN_PCT = 0.898; 
        const IMG_Y_MAX_PCT = 0.055; 

        const ABGApp = () => {
            const [inputs, setInputs] = useState({ pH: 7.40, pCO2: 40, hco3: 24 });
            const [dotPos, setDotPos] = useState({ x: 53.95, y: 56.12 }); // 預設 7.4, 24 的位置
            const [analysis, setAnalysis] = useState({ result: '正常 (Normal)', causes: ['無明顯酸鹼異常'] });
            const imgRef = useRef(null);

            // 當數值改變時，重新分析並移動圖片上的紅點
            useEffect(() => {
                const { pH, pCO2, hco3 } = inputs;
                updateDotPosition(pH, hco3);
                const res = interpretABG(pH, pCO2, hco3);
                setAnalysis(res);
            }, [inputs]);

            // 計算並更新紅點的 X, Y 百分比座標
            const updateDotPosition = (pH, hco3) => {
                let p = parseFloat(pH);
                let h = parseFloat(hco3);
                if (isNaN(p) || isNaN(h)) return;
                
                // 限制在圖表範圍內顯示
                p = Math.max(GRAPH_X_MIN, Math.min(GRAPH_X_MAX, p));
                h = Math.max(GRAPH_Y_MIN, Math.min(GRAPH_Y_MAX, h));

                const xRatio = (p - GRAPH_X_MIN) / (GRAPH_X_MAX - GRAPH_X_MIN);
                const yRatio = (h - GRAPH_Y_MIN) / (GRAPH_Y_MAX - GRAPH_Y_MIN);

                const pctX = (IMG_X_MIN_PCT + xRatio * (IMG_X_MAX_PCT - IMG_X_MIN_PCT)) * 100;
                const pctY = (IMG_Y_MIN_PCT - yRatio * (IMG_Y_MIN_PCT - IMG_Y_MAX_PCT)) * 100;
                
                setDotPos({ x: pctX, y: pctY });
            };

            // 處理圖片點擊事件
            const handleImageClick = (e) => {
                if (!imgRef.current) return;
                const rect = imgRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const pctX = x / rect.width;
                const pctY = y / rect.height;

                // 將點擊的百分比轉換為 pH 與 HCO3
                let xRatio = (pctX - IMG_X_MIN_PCT) / (IMG_X_MAX_PCT - IMG_X_MIN_PCT);
                let yRatio = (IMG_Y_MIN_PCT - pctY) / (IMG_Y_MIN_PCT - IMG_Y_MAX_PCT);

                let newPh = GRAPH_X_MIN + xRatio * (GRAPH_X_MAX - GRAPH_X_MIN);
                let newHco3 = GRAPH_Y_MIN + yRatio * (GRAPH_Y_MAX - GRAPH_Y_MIN);

                // 限制在圖表範圍內
                newPh = Math.max(GRAPH_X_MIN, Math.min(GRAPH_X_MAX, newPh));
                newHco3 = Math.max(GRAPH_Y_MIN, Math.min(GRAPH_Y_MAX, newHco3));

                // 根據 Henderson-Hasselbalch 方程式推算 pCO2
                // [H+] = 24 * (pCO2 / HCO3)  -> pCO2 = HCO3 / (0.03 * 10^(pH - 6.1))
                let newPco2 = newHco3 / (0.03 * Math.pow(10, newPh - 6.1));
                
                setInputs({
                    pH: newPh.toFixed(2),
                    pCO2: newPco2.toFixed(1),
                    hco3: newHco3.toFixed(1)
                });
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({ ...prev, [name]: value }));
            };

            // ABG 判讀核心邏輯
            const interpretABG = (pHStr, pCO2Str, HCO3Str) => {
                const pH = parseFloat(pHStr);
                const pCO2 = parseFloat(pCO2Str);
                const HCO3 = parseFloat(HCO3Str);

                if (isNaN(pH) || isNaN(pCO2) || isNaN(HCO3)) {
                    return { result: '等待完整數值...', causes: [] };
                }

                let result = "";
                let causes = [];

                const isAcidemia = pH < 7.35;
                const isAlkalemia = pH > 7.45;
                const isNormalPh = pH >= 7.35 && pH <= 7.45;

                if (isNormalPh && pCO2 >= 35 && pCO2 <= 45 && HCO3 >= 22 && HCO3 <= 26) {
                    return { result: "正常 (Normal)", causes: ["無明顯酸鹼異常"] };
                }

                if (isAcidemia) {
                    if (pCO2 > 45 && HCO3 < 22) {
                        result = "混合型酸中毒 (Mixed Acidosis)";
                        causes = ["同時存在呼吸衰竭與代謝性酸中毒 (如心跳停止、嚴重敗血症合併呼吸衰竭)"];
                    } else if (pCO2 > 45) {
                        let expHco3Acute = 24 + 0.1 * (pCO2 - 40);
                        let expHco3Chronic = 24 + 0.4 * (pCO2 - 40);
                        if (Math.abs(HCO3 - expHco3Acute) < Math.abs(HCO3 - expHco3Chronic)) {
                            result = "急性呼吸性酸中毒 (Acute Resp. Acidosis)";
                        } else {
                            result = "慢性呼吸性酸中毒 (Chronic Resp. Acidosis)";
                        }
                        causes = ["中樞神經抑制 (如安眠藥過量)", "氣道阻塞 (如異物、氣喘嚴重發作)", "神經肌肉疾病 (如重症肌無力)", "COPD 急性惡化"];
                    } else if (HCO3 < 22) {
                        let expPco2 = 1.5 * HCO3 + 8;
                        if (pCO2 < expPco2 - 2) {
                            result = "代謝性酸中毒合併呼吸性鹼中毒";
                        } else if (pCO2 > expPco2 + 2) {
                            result = "代謝性酸中毒合併呼吸性酸中毒";
                        } else {
                            result = "單純代謝性酸中毒 (Metabolic Acidosis)";
                        }
                        causes = ["高陰離子間隙 (MUDPILES): 乳酸酸中毒、糖尿病酮酸中毒(DKA)、尿毒症、中毒(甲醇/水楊酸)", "正常陰離子間隙: 嚴重腹瀉、腎小管酸中毒 (RTA)"];
                    } else {
                        result = "酸血症 (需進一步臨床資訊)";
                    }
                } else if (isAlkalemia) {
                    if (pCO2 < 35 && HCO3 > 26) {
                        result = "混合型鹼中毒 (Mixed Alkalosis)";
                        causes = ["如肝硬化患者使用利尿劑，並伴隨過度換氣"];
                    } else if (pCO2 < 35) {
                        let expHco3Acute = 24 - 0.2 * (40 - pCO2);
                        let expHco3Chronic = 24 - 0.4 * (40 - pCO2);
                        if (Math.abs(HCO3 - expHco3Acute) < Math.abs(HCO3 - expHco3Chronic)) {
                            result = "急性呼吸性鹼中毒 (Acute Resp. Alkalosis)";
                        } else {
                            result = "慢性呼吸性鹼中毒 (Chronic Resp. Alkalosis)";
                        }
                        causes = ["過度換氣症候群 (焦慮, 疼痛)", "缺氧 (如高海拔, 早期肺栓塞)", "中樞神經系統疾病", "敗血症早期"];
                    } else if (HCO3 > 26) {
                        let expPco2 = 0.7 * HCO3 + 21;
                        if (pCO2 > expPco2 + 2) {
                            result = "代謝性鹼中毒合併呼吸性酸中毒";
                        } else if (pCO2 < expPco2 - 2) {
                            result = "代謝性鹼中毒合併呼吸性鹼中毒";
                        } else {
                            result = "單純代謝性鹼中毒 (Metabolic Alkalosis)";
                        }
                        causes = ["腸胃道流失 (嚴重嘔吐, 鼻胃管大量引流)", "腎臟流失 (利尿劑使用)", "低血鉀", "原發性醛固酮增多症"];
                    } else {
                        result = "鹼血症 (需進一步臨床資訊)";
                    }
                } else {
                    if (pCO2 > 45 && HCO3 > 26) {
                        result = pH < 7.4 ? "慢性呼吸性酸中毒 (代償完全) 或 混合型" : "代謝性鹼中毒 (代償完全) 或 混合型";
                        causes = ["COPD患者合併利尿劑使用", "長期慢性嘔吐患者"];
                    } else if (pCO2 < 35 && HCO3 < 22) {
                        result = pH < 7.4 ? "代謝性酸中毒 (代償完全) 或 混合型" : "慢性呼吸性鹼中毒 (代償完全) 或 混合型";
                        causes = ["水楊酸中毒 (早期呼吸鹼，後期代謝酸)", "敗血症"];
                    } else {
                        result = "正常範圍內，或輕微混合型異常";
                        causes = ["數值位於正常邊緣"];
                    }
                }

                // 驗證數值合理性 (利用 Henderson-Hasselbalch)
                const calc_pH = 6.1 + Math.log10(HCO3 / (0.03 * pCO2));
                if (Math.abs(calc_pH - pH) > 0.08) {
                    causes.unshift("⚠️ 警告：輸入的數值 (pH, pCO2, HCO3) 在生理學公式中不吻合，請確認數據是否輸入錯誤或檢體誤差。");
                }

                return { result, causes };
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
                    <div className="max-w-6xl w-full">
                        <header className="mb-6 flex items-center space-x-3 text-blue-800">
                            <i data-lucide="activity" className="w-8 h-8"></i>
                            <h1 className="text-3xl font-bold">ABG 酸鹼判讀與病因分析</h1>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            
                            {/* 左側：互動式圖表 */}
                            <div className="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 flex flex-col">
                                <h2 className="text-lg font-semibold mb-3 flex items-center text-slate-700">
                                    <i data-lucide="mouse-pointer-click" className="w-5 h-5 mr-2"></i>
                                    點擊圖表區域或手動輸入
                                </h2>
                                <div className="relative w-full overflow-hidden rounded-xl border border-slate-200 cursor-crosshair bg-slate-50" onClick={handleImageClick}>
                                    <img 
                                        ref={imgRef}
                                        src="Screenshot_20260222_143012_Samsung Internet.jpg" 
                                        alt="ABG Nomogram" 
                                        className="w-full h-auto pointer-events-none select-none"
                                        onError={(e) => {
                                            e.target.onerror = null; 
                                            e.target.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400" viewBox="0 0 600 400"><rect width="100%" height="100%" fill="%23f1f5f9"/><text x="50%" y="50%" font-family="sans-serif" font-size="16" fill="%2364748b" text-anchor="middle">請將圖片命名為 Screenshot_20260222_143012_Samsung Internet.jpg</text><text x="50%" y="60%" font-family="sans-serif" font-size="16" fill="%2364748b" text-anchor="middle">並與 index.html 放在同一目錄下</text></svg>';
                                        }}
                                    />
                                    {/* 互動紅點 */}
                                    <div 
                                        className="absolute w-4 h-4 bg-red-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-lg border-2 border-white transition-all duration-300 pointer-events-none"
                                        style={{ left: `${dotPos.x}%`, top: `${dotPos.y}%` }}
                                    ></div>
                                </div>
                                <p className="text-sm text-slate-500 mt-3 flex items-center">
                                    <i data-lucide="info" className="w-4 h-4 mr-1"></i>
                                    點擊圖表任一處，將自動根據公式推算對應的 pH, PaCO2 與 HCO3。
                                </p>
                            </div>

                            {/* 右側：輸入與判讀結果 */}
                            <div className="space-y-6">
                                
                                {/* 手動輸入區塊 */}
                                <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                                    <h2 className="text-xl font-bold mb-4 text-slate-800 flex items-center">
                                        <i data-lucide="calculator" className="w-5 h-5 mr-2 text-blue-600"></i>
                                        患者檢驗數據 (手動輸入)
                                    </h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">pH</label>
                                            <input type="number" name="pH" value={inputs.pH} onChange={handleInputChange} step="0.01" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow text-center font-mono text-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">PaCO2 <span className="text-xs text-slate-400">mmHg</span></label>
                                            <input type="number" name="pCO2" value={inputs.pCO2} onChange={handleInputChange} step="0.1" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow text-center font-mono text-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">HCO3- <span className="text-xs text-slate-400">mmol/L</span></label>
                                            <input type="number" name="hco3" value={inputs.hco3} onChange={handleInputChange} step="0.1" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow text-center font-mono text-lg" />
                                        </div>
                                    </div>
                                </div>

                                {/* 判讀結果區塊 */}
                                <div className="bg-blue-50 p-6 rounded-2xl shadow-lg border border-blue-100">
                                    <h2 className="text-xl font-bold mb-4 text-blue-900 flex items-center">
                                        <i data-lucide="stethoscope" className="w-5 h-5 mr-2"></i>
                                        判讀結果
                                    </h2>
                                    <div className="bg-white rounded-xl p-4 shadow-sm border border-blue-50 mb-4">
                                        <p className="text-2xl font-bold text-blue-700 text-center">{analysis.result}</p>
                                    </div>
                                    
                                    <h3 className="text-md font-bold text-blue-900 mb-2 flex items-center mt-5">
                                        <i data-lucide="book-open" className="w-4 h-4 mr-2"></i>
                                        潛在病因分析 (Etiology)
                                    </h3>
                                    <ul className="space-y-2">
                                        {analysis.causes.map((cause, index) => (
                                            <li key={index} className="flex items-start">
                                                <span className={`mr-2 mt-1 flex-shrink-0 ${cause.includes('⚠️') ? 'text-red-500' : 'text-blue-500'}`}>
                                                    {cause.includes('⚠️') ? '' : '•'}
                                                </span>
                                                <span className={cause.includes('⚠️') ? 'text-red-600 font-semibold text-sm' : 'text-slate-700'}>
                                                    {cause}
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ABGApp />);

        // 初始化圖標
        setTimeout(() => {
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }, 100);
    </script>
</body>
</html>

