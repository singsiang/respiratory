<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ROX Index 計算器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- React, ReactDOM, and Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --primary: #1565c0;
      --bg-color: #f5f7fb;
      --card-bg: #ffffff;
      --text-main: #333;
      --text-sub: #666;
      --border: #e0e0e0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Noto Sans TC", sans-serif;
      background: var(--bg-color);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 24px;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 8px 0;
      text-align: center;
      color: var(--text-main);
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
      text-align: center;
      margin-bottom: 20px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    input[type="number"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
    }

    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .error {
      font-size: 12px;
      color: #d32f2f;
      margin-top: 4px;
      font-weight: 500;
    }

    /* Result Section */
    .result-card {
      margin-top: 24px;
      padding: 20px;
      border-radius: 10px;
      background: #f0f4ff;
      border: 1px solid #dbeafe;
      text-align: center;
    }

    .rox-value-large {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      margin: 8px 0;
      line-height: 1;
    }

    /* Status Badges */
    .status {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    .status-low { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .status-mid { background: #fff8e1; color: #f57f17; border: 1px solid #ffe082; }
    .status-high { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.2s;
    }
    .btn-save {
      background: var(--primary);
      color: white;
    }
    .btn-save:hover { background: #0d47a1; }
    .btn-save:disabled { background: #cfd8dc; cursor: not-allowed; }

    .btn-clear {
      background: transparent;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
      margin-top: 0;
      width: auto;
      padding: 6px 12px;
      font-size: 12px;
    }

    /* History Section */
    .history-section {
      margin-top: 32px;
      border-top: 2px solid #f0f0f0;
      padding-top: 20px;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .history-title {
      font-size: 16px;
      font-weight: 700;
      color: #444;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .history-item {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    
    .history-info {
      flex: 1;
    }

    .history-time {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .history-score {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }

    .history-details {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .btn-delete {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 8px;
      font-size: 18px;
    }
    .btn-delete:hover {
      color: #d32f2f;
    }

    .empty-state {
      text-align: center;
      color: #aaa;
      font-size: 13px;
      padding: 20px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px dashed #ddd;
    }
    
    .ref {
      margin-top: 24px;
      font-size: 11px;
      color: #999;
      line-height: 1.5;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect } = React;

  // 風險分級邏輯
  function classifyROX(rox) {
    if (isNaN(rox) || !isFinite(rox)) {
      return { level: "N/A", text: "請輸入完整數值", className: "" };
    }
    if (rox >= 4.88) {
      return { level: "✓ 低風險", text: "ROX ≥ 4.88 (成功機率較高)", className: "status status-low" };
    } else if (rox >= 3.85) {
      return { level: "⚠ 中等風險", text: "3.85 ≤ ROX < 4.88 (密切觀察)", className: "status status-mid" };
    } else if (rox >= 2.85) {
      return { level: "⚠ 高風險", text: "2.85 ≤ ROX < 3.85 (插管風險高)", className: "status status-high" };
    } else {
      return { level: "✕ 極高風險", text: "ROX < 2.85 (極高失敗率)", className: "status status-high" };
    }
  }

  function App() {
    const [spo2, setSpo2] = useState("");
    const [fio2Percent, setFio2Percent] = useState("");
    const [rr, setRr] = useState("");
    const [history, setHistory] = useState([]);
    
    // 初始化時從 LocalStorage 讀取紀錄
    useEffect(() => {
      const saved = localStorage.getItem('rox-history');
      if (saved) {
        try {
          setHistory(JSON.parse(saved));
        } catch (e) {
          console.error("Failed to parse history", e);
        }
      }
    }, []);

    // 當 history 變更時，存入 LocalStorage
    useEffect(() => {
      localStorage.setItem('rox-history', JSON.stringify(history));
    }, [history]);

    const spo2Num = parseFloat(spo2);
    const fio2PercentNum = parseFloat(fio2Percent);
    const rrNum = parseFloat(rr);

    const fio2Decimal = (!isNaN(fio2PercentNum) && fio2PercentNum > 0) ? fio2PercentNum / 100 : NaN;
    
    let sfRatio = null;
    let rox = null;
    let errors = {};

    // 驗證邏輯
    if (spo2 !== "" && (spo2Num <= 0 || spo2Num > 100)) errors.spo2 = "SpO₂ 應介於 1–100";
    if (fio2Percent !== "" && (fio2PercentNum < 21 || fio2PercentNum > 100)) errors.fio2 = "FiO₂ 通常介於 21–100%";
    if (rr !== "" && (rrNum <= 0 || rrNum > 80)) errors.rr = "RR 應介於 1–80";

    // 計算
    if (!isNaN(spo2Num) && !isNaN(fio2Decimal) && fio2Decimal > 0) {
      sfRatio = spo2Num / fio2Decimal;
    }
    if (sfRatio !== null && !isNaN(rrNum) && rrNum > 0) {
      rox = sfRatio / rrNum;
    }

    const risk = classifyROX(rox);
    const isCalculatable = rox !== null && isFinite(rox);

    const handleSave = () => {
      if (!isCalculatable) return;
      
      const newRecord = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
        spo2: spo2Num,
        fio2: fio2PercentNum,
        rr: rrNum,
        rox: rox.toFixed(2),
        riskLevel: risk.level,
        riskClass: risk.className
      };

      setHistory([newRecord, ...history]);
    };

    const handleDelete = (id) => {
      setHistory(history.filter(item => item.id !== id));
    };

    const handleClearAll = () => {
      if (confirm("確定要清除所有紀錄嗎？")) {
        setHistory([]);
      }
    };

    return (
      <div className="container">
        <h1>ROX Index 計算器</h1>
        <div className="subtitle">公式：(SpO₂ / FiO₂) / RR</div>

        <div className="field-group">
          <label>SpO₂ (%)</label>
          <input 
            type="number" 
            step="0.1" 
            value={spo2} 
            onChange={(e) => setSpo2(e.target.value)} 
            placeholder="例如 94" 
          />
          {errors.spo2 && <div className="error">{errors.spo2}</div>}
        </div>

        <div className="field-group">
          <label>FiO₂ (%)</label>
          <input 
            type="number" 
            step="1" 
            value={fio2Percent} 
            onChange={(e) => setFio2Percent(e.target.value)} 
            placeholder="例如 30" 
          />
          <div className="hint">請輸入整數 (30 = 30%)</div>
          {errors.fio2 && <div className="error">{errors.fio2}</div>}
        </div>

        <div className="field-group">
          <label>RR (呼吸次數/分)</label>
          <input 
            type="number" 
            step="1" 
            value={rr} 
            onChange={(e) => setRr(e.target.value)} 
            placeholder="例如 25" 
          />
          {errors.rr && <div className="error">{errors.rr}</div>}
        </div>

        <div className="result-card">
          <div style={{ fontSize: '14px', color: '#555' }}>ROX Index</div>
          <div className="rox-value-large">
            {isCalculatable ? rox.toFixed(2) : "—"}
          </div>
          {isCalculatable && (
            <>
              <div style={{ fontSize: '13px', marginBottom: '8px', color: '#666' }}>
                SpO₂/FiO₂ = {sfRatio.toFixed(1)}
              </div>
              <div className={risk.className}>
                {risk.text}
              </div>
            </>
          )}
          
          <button 
            className="btn btn-save" 
            onClick={handleSave} 
            disabled={!isCalculatable}
          >
            {isCalculatable ? "加入紀錄" : "請輸入完整數值"}
          </button>
        </div>

        <div className="history-section">
          <div className="history-header">
            <span className="history-title">歷史紀錄 ({history.length})</span>
            {history.length > 0 && (
              <button className="btn btn-clear" onClick={handleClearAll}>
                清除全部
              </button>
            )}
          </div>
          
          <div className="history-list">
            {history.length === 0 ? (
              <div className="empty-state">尚未有儲存的紀錄</div>
            ) : (
              history.map((item) => (
                <div key={item.id} className="history-item">
                  <div className="history-info">
                    <div className="history-time">{item.timestamp}</div>
                    <div className="history-score" style={{ 
                      color: item.rox >= 4.88 ? '#2e7d32' : (item.rox >= 2.85 ? '#f57f17' : '#c62828') 
                    }}>
                      ROX: {item.rox}
                      <span style={{ fontSize: '12px', fontWeight: 'normal', marginLeft: '6px', color: '#666' }}>
                        {item.riskLevel}
                      </span>
                    </div>
                    <div className="history-details">
                      S: {item.spo2}% | F: {item.fio2}% | RR: {item.rr}
                    </div>
                  </div>
                  <button className="btn-delete" onClick={() => handleDelete(item.id)} title="刪除">
                    &times;
                  </button>
                </div>
              ))
            )}
          </div>
        </div>

        <div className="ref">
          本工具僅供教學與初步評估參考，ROX Index 定義與臨床處置請參考相關醫學指引。
        </div>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App />);
</script>

</body>
</html>
