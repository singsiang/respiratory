<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>呼吸器空機點班系統</title>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 React 與 ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- 引入 Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 引入 html2canvas 用於匯出圖片 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* 隱藏滾動條但保持可以滾動 */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* 防止手機點擊閃爍，提升 App 原生感 */
    body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; overflow-x: hidden; }
    /* 隱藏數字輸入框的預設上下箭頭 */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-24 w-full">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- SVG 圖示元件 (加入 className 支援以利縮放) ---
    const IconClipboard = ({className="w-5 h-5 sm:w-6 sm:h-6"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>;
    const IconCamera = ({className="w-5 h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
    const IconCheck = ({className="w-6 h-6 sm:w-8 sm:h-8"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>;
    const IconX = ({className="w-3.5 h-3.5 sm:w-4 sm:h-4"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
    const IconPlus = ({className="w-4 h-4 sm:w-5 sm:h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const IconMinus = ({className="w-4 h-4 sm:w-5 sm:h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>;

    // --- 資料模型 ---
    const AREAS = ['9F', 'MICU', 'ER', 'VMICU'];
    const ITEMS = [
      { id: 'po_por', name: 'PO(por)', validAreas: ['VMICU'], isYellow: true },
      { id: 'po_nt1d', name: 'PO(NT1D)', validAreas: ['9F', 'VMICU'], isYellow: true },
      { id: 'savina', name: 'Savina', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'savina300', name: 'Savina300', validAreas: ['9F', 'MICU'] },
      { id: 'v600', name: 'V600', validAreas: ['9F', 'MICU'] },
      { id: 'servo300', name: 'Servo300', validAreas: ['9F'] },
      { id: 'galileo', name: 'Galileo', validAreas: ['9F'] },
      { id: 'dura', name: 'Dura', validAreas: ['MICU'] },
      { id: 'evita4', name: 'Evita-4', validAreas: ['MICU', 'VMICU'] },
      { id: 'po', name: 'PO', validAreas: ['9F'] },
      { id: 'nonin', name: 'Nonin', validAreas: ['9F'] },
      { id: 'hfnc', name: 'HFNC(AirVO2)', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'flexo', name: 'Flexo', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'trilogy', name: 'Trilogy', validAreas: ['VMICU'] },
      { id: 'stellar', name: 'Stellar', validAreas: ['9F', 'MICU', 'ER'] }
    ];

    function App() {
      const [activeTab, setActiveTab] = useState('9F');
      const [inventory, setInventory] = useState({});
      const [focusedItem, setFocusedItem] = useState(null); 
      const [isExporting, setIsExporting] = useState(false);
      const [modal, setModal] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
      const tableRef = useRef(null);

      useEffect(() => {
        const initialData = {};
        AREAS.forEach(area => {
          initialData[area] = {};
          ITEMS.forEach(item => {
            initialData[area][item.id] = item.validAreas.includes(area) ? '0' : 'N/A';
          });
        });
        
        try {
          const savedData = localStorage.getItem('hospital_inventory_v5');
          if (savedData) setInventory(JSON.parse(savedData));
          else setInventory(initialData);
        } catch (e) {
          setInventory(initialData);
        }
      }, []);

      useEffect(() => {
        if (Object.keys(inventory).length > 0) {
          localStorage.setItem('hospital_inventory_v5', JSON.stringify(inventory));
        }
      }, [inventory]);

      const showAlert = (message) => setModal({ isOpen: true, type: 'alert', message, onConfirm: null });
      const showConfirm = (message, onConfirm) => setModal({ isOpen: true, type: 'confirm', message, onConfirm });
      const closeModal = () => setModal({ isOpen: false, type: 'alert', message: '', onConfirm: null });

      const handleInputChange = (area, itemId, value) => {
        setInventory(prev => ({ ...prev, [area]: { ...prev[area], [itemId]: value } }));
        setFocusedItem(itemId);
      };

      const handleMainMathChange = (area, itemId, delta) => {
        setInventory(prev => {
          const currentStr = String(prev[area][itemId] || '0');
          const match = currentStr.match(/^(\d+)(.*)/);
          let num = 0;
          let rest = '';
          
          if (match) {
            num = parseInt(match[1], 10);
            rest = match[2];
          } else {
            rest = currentStr;
          }

          num = Math.max(0, num + delta);

          return {
            ...prev,
            [area]: { ...prev[area], [itemId]: `${num}${rest}` }
          };
        });
        setFocusedItem(itemId);
      };

      const handleStatusIncrease = (area, itemId, statusType) => {
         setInventory(prev => {
            const currentStr = String(prev[area][itemId] || '0');
            const regex = new RegExp(`\\+(\\d+)\\(${statusType}\\)`);
            const match = currentStr.match(regex);
            let newStr = '';

            if (match) {
              const currentStatusCount = parseInt(match[1], 10);
              const newStatusCount = currentStatusCount + 1;
              newStr = currentStr.replace(regex, `+${newStatusCount}(${statusType})`);
            } else {
              newStr = `${currentStr}+1(${statusType})`;
            }

            return {
              ...prev,
              [area]: { ...prev[area], [itemId]: newStr }
            };
         });
         setFocusedItem(itemId);
      };

      const handleResetItem = (area, itemId) => {
        setInventory(prev => ({ ...prev, [area]: { ...prev[area], [itemId]: '0' } }));
        setFocusedItem(itemId);
      };

      const requestClearData = () => {
        showConfirm('確定要清空所有點班紀錄嗎？所有數字與註記將會歸零。', () => {
          const resetData = { ...inventory };
          AREAS.forEach(area => {
            ITEMS.forEach(item => {
              if (item.validAreas.includes(area)) resetData[area][item.id] = '0';
            });
          });
          setInventory(resetData);
          setFocusedItem(null);
          showAlert('資料已成功清空！');
        });
      };

      const exportAsImage = async () => {
        if (!window.html2canvas) {
          showAlert('系統尚未準備好，請稍後再試。');
          return;
        }
        
        setIsExporting(true);
        try {
          const canvas = await window.html2canvas(tableRef.current, {
            scale: 2, backgroundColor: '#ffffff', useCORS: true
          });
          
          const image = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.href = image;
          const d = new Date();
          const dateString = `${d.getMonth()+1}月${d.getDate()}日_${d.getHours()}時${d.getMinutes()}分`;
          link.download = `空機點班統計_${dateString}.png`;
          link.click();
        } catch (err) {
          console.error('匯出失敗:', err);
          showAlert('匯出圖片失敗，請確認瀏覽器支援此功能。');
        } finally {
          setIsExporting(false);
        }
      };

      if (Object.keys(inventory).length === 0) {
        return <div className="p-10 text-center text-slate-500 flex flex-col items-center"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>系統載入中...</div>;
      }

      return (
        <div className="min-h-screen flex flex-col w-full" onClick={() => setFocusedItem(null)}>
          {/* 自訂 Modal */}
          {modal.isOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                <div className="p-5 sm:p-6">
                  <h3 className="text-base sm:text-lg font-bold text-slate-800 mb-2">系統提示</h3>
                  <p className="text-sm sm:text-base text-slate-600">{modal.message}</p>
                </div>
                <div className="bg-slate-50 p-3 sm:p-4 flex justify-end gap-3 border-t border-slate-100">
                  {modal.type === 'confirm' && (
                    <button onClick={closeModal} className="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 font-medium">
                      取消
                    </button>
                  )}
                  <button 
                    onClick={() => {
                      if (modal.onConfirm) modal.onConfirm();
                      closeModal();
                    }} 
                    className="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-medium"
                  >
                    確定
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 頂部導覽列 */}
          <header className="bg-blue-700 text-white shadow-md sticky top-0 z-40 w-full" onClick={e => e.stopPropagation()}>
            <div className="max-w-4xl mx-auto px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center">
              <div className="flex items-center gap-1.5 sm:gap-2">
                <IconClipboard />
                <h1 className="text-base sm:text-lg md:text-xl font-bold tracking-wide">空機點班</h1>
              </div>
              <button onClick={requestClearData} className="text-blue-200 hover:text-white flex items-center gap-1 text-xs sm:text-sm bg-blue-800 px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-lg transition active:scale-95">
                <IconX />清空
              </button>
            </div>
            
            {/* 標籤頁切換 */}
            <div className="flex overflow-x-auto hide-scrollbar border-t border-blue-600 w-full">
              {AREAS.map(area => (
                <button
                  key={area}
                  onClick={() => { setActiveTab(area); setFocusedItem(null); }}
                  className={`flex-1 py-2.5 sm:py-3 px-2 sm:px-4 min-w-[65px] sm:min-w-[80px] text-sm sm:text-base text-center font-medium border-b-4 transition-colors ${
                    activeTab === area ? 'border-white bg-blue-800 text-white' : 'border-transparent text-blue-200 hover:bg-blue-600'
                  }`}
                >
                  {area}
                </button>
              ))}
              <button
                onClick={() => { setActiveTab('SUMMARY'); setFocusedItem(null); }}
                className={`flex-1 py-2.5 sm:py-3 px-2 sm:px-4 min-w-[85px] sm:min-w-[100px] text-sm sm:text-base text-center font-bold border-b-4 transition-colors ${
                  activeTab === 'SUMMARY' ? 'border-yellow-400 bg-blue-800 text-yellow-400' : 'border-transparent text-blue-200 hover:bg-blue-600'
                }`}
              >
                總表預覽
              </button>
            </div>
          </header>

          <main className="flex-1 max-w-4xl w-full mx-auto p-2.5 sm:p-4 md:p-6 pb-32">
            {/* 區域點班區塊 */}
            {AREAS.includes(activeTab) && (
              <div className="space-y-3 sm:space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                <div className="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center mb-1">
                  <div>
                    <h2 className="text-base sm:text-lg font-bold text-slate-700">區域：{activeTab}</h2>
                    <p className="text-[11px] sm:text-xs text-slate-500 mt-0.5">點選機型會放大顯示，方便操作</p>
                  </div>
                  <div className="text-green-500 opacity-20"><IconCheck /></div>
                </div>

                {/* --- 核心修改：強制 grid-cols-2 (一排2個) --- */}
                <div className="grid grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4">
                  {ITEMS.filter(item => item.validAreas.includes(activeTab)).map(item => {
                    const isFocused = focusedItem === item.id;
                    const isUnchanged = inventory[activeTab][item.id] === '0';
                    
                    return (
                      <div 
                        key={item.id} 
                        onClick={(e) => { e.stopPropagation(); setFocusedItem(item.id); }}
                        className={`bg-white p-2.5 sm:p-4 rounded-xl border flex flex-col gap-2 transition-all duration-200 ease-in-out cursor-pointer select-none
                          ${isFocused 
                            ? 'scale-[1.03] shadow-lg border-blue-500 ring-2 ring-blue-200 z-10' 
                            : 'scale-100 shadow-sm border-slate-200 hover:border-blue-300'
                          }`}
                      >
                        <div className="flex justify-between items-start pointer-events-none">
                          <label className="font-bold text-[13px] sm:text-base text-slate-800 leading-tight">
                            {item.name}
                          </label>
                          {isUnchanged && (
                            <span className="text-[9px] sm:text-xs font-normal text-slate-400 bg-slate-100 px-1 py-0.5 sm:px-2 sm:py-1 rounded whitespace-nowrap ml-1">
                              未異動
                            </span>
                          )}
                        </div>
                        
                        {/* 主數字增減區塊 (更緊湊) */}
                        <div className="flex gap-1 sm:gap-2 items-center w-full">
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleMainMathChange(activeTab, item.id, -1); }}
                            className={`flex-none w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition-colors ${isFocused ? 'bg-blue-50 text-blue-600 border border-blue-200' : ''}`}
                          >
                            <IconMinus />
                          </button>
                          
                          <input
                            type="text"
                            value={inventory[activeTab][item.id]}
                            onChange={(e) => handleInputChange(activeTab, item.id, e.target.value)}
                            onClick={(e) => { e.stopPropagation(); setFocusedItem(item.id); }}
                            className={`min-w-0 w-full flex-1 text-center text-base sm:text-xl font-bold p-1 sm:p-1.5 h-8 sm:h-10 border rounded-lg outline-none transition-colors 
                              ${isFocused ? 'border-blue-500 bg-blue-50/30' : 'border-slate-300'}`}
                          />
                          
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleMainMathChange(activeTab, item.id, 1); }}
                            className={`flex-none w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition-colors ${isFocused ? 'bg-blue-50 text-blue-600 border border-blue-200' : ''}`}
                          >
                            <IconPlus />
                          </button>
                        </div>
                        
                        {/* 狀態快捷鍵 (採用2x2微型網格，省空間且對齊) */}
                        <div className="grid grid-cols-2 gap-1 mt-auto w-full">
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleStatusIncrease(activeTab, item.id, '請修'); }} 
                            className="col-span-1 py-1.5 bg-red-50 hover:bg-red-100 text-red-700 rounded-md text-[10px] sm:text-xs font-medium transition active:scale-95 border border-red-100 flex items-center justify-center leading-none"
                          >
                            +1(請修)
                          </button>
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleStatusIncrease(activeTab, item.id, '轉送'); }} 
                            className="col-span-1 py-1.5 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-md text-[10px] sm:text-xs font-medium transition active:scale-95 border border-orange-100 flex items-center justify-center leading-none"
                          >
                            +1(轉送)
                          </button>
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleResetItem(activeTab, item.id); }} 
                            className="col-span-2 py-1.5 bg-slate-100 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-md text-[11px] sm:text-xs font-medium active:scale-95 transition-colors border border-transparent flex items-center justify-center leading-none"
                          >
                            歸零
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* 總表預覽區塊 */}
            {activeTab === 'SUMMARY' && (
              <div className="space-y-3 sm:space-y-4 animate-in fade-in zoom-in-95 duration-300" onClick={e => e.stopPropagation()}>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-slate-200">
                  <div>
                    <h2 className="text-base sm:text-lg font-bold text-slate-800">統計總表</h2>
                    <p className="text-[11px] sm:text-sm text-slate-500 mt-0.5">請確認表格數據，並透過下方左右滑動查看</p>
                  </div>
                  <button 
                    onClick={exportAsImage}
                    disabled={isExporting}
                    className="w-full sm:w-auto flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 sm:px-5 sm:py-3 rounded-lg text-sm sm:text-base font-bold shadow-lg shadow-emerald-600/20 transition-all disabled:opacity-70 active:scale-95"
                  >
                    {isExporting ? '生成圖片中...' : <><IconCamera /> 儲存為圖片分享</>}
                  </button>
                </div>

                <div className="w-full max-w-[calc(100vw-1.2rem)] sm:max-w-full overflow-x-auto bg-white p-1 sm:p-2 rounded-xl shadow-sm border border-slate-200 custom-scrollbar">
                  <div ref={tableRef} className="p-2 sm:p-4 bg-white min-w-[500px] sm:min-w-[650px]">
                    <table className="w-full border-collapse border-2 border-slate-800 text-center text-[13px] sm:text-[15px]">
                      <thead>
                        <tr>
                          <th className="border border-slate-800 p-1.5 sm:p-2 bg-slate-100 font-bold text-slate-800 w-1/5">空機統計</th>
                          {AREAS.map(area => (
                            <th key={area} className="border border-slate-800 p-1.5 sm:p-2 bg-slate-100 font-bold text-slate-800 w-1/5">{area}</th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {ITEMS.map(item => (
                          <tr key={item.id}>
                            <td className={`border border-slate-800 p-1.5 sm:p-2 font-bold text-left ${item.isYellow ? 'bg-amber-400' : 'bg-white'}`}>
                              {item.name}
                            </td>
                            {AREAS.map(area => {
                              const val = inventory[area]?.[item.id];
                              const isNA = val === 'N/A';
                              return (
                                <td 
                                  key={`${area}-${item.id}`} 
                                  className={`border border-slate-800 p-1.5 sm:p-2 ${isNA ? 'bg-gray-300 text-slate-500 text-xs sm:text-sm' : 'bg-white text-slate-900 font-bold text-base sm:text-lg'}`}
                                >
                                  {val}
                                </td>
                              );
                            })}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>


