import React, { useState, useEffect, useRef } from 'react';
import { ClipboardList, Camera, CheckCircle2, AlertCircle, Share2, Save, XCircle } from 'lucide-react';

// å®šç¾©ç—…æˆ¿å€åŸŸ
const AREAS = ['9F', 'MICU', 'ER', 'VMICU'];

// å®šç¾©å„€å™¨åˆ—è¡¨èˆ‡å…¶é©ç”¨çš„å€åŸŸ
const ITEMS = [
  { id: 'po_por', name: 'PO(por)', validAreas: ['VMICU'], isYellow: true },
  { id: 'po_nt1d', name: 'PO(NT1D)', validAreas: ['9F', 'VMICU'], isYellow: true },
  { id: 'savina', name: 'Savina', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
  { id: 'savina300', name: 'Savina300', validAreas: ['9F', 'MICU'] },
  { id: 'v600', name: 'V600', validAreas: ['9F', 'MICU'] },
  { id: 'servo300', name: 'Servo300', validAreas: ['9F'] },
  { id: 'galileo', name: 'Galileo', validAreas: ['9F'] },
  { id: 'dura', name: 'Dura', validAreas: ['MICU'] },
  { id: 'evita4', name: 'Evita-4', validAreas: ['MICU', 'VMICU'] },
  { id: 'po', name: 'PO', validAreas: ['9F'] },
  { id: 'nonin', name: 'Nonin', validAreas: ['9F'] },
  { id: 'hfnc', name: 'HFNC(AirVO2)', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
  { id: 'flexo', name: 'Flexo', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
  { id: 'trilogy', name: 'Trilogy', validAreas: ['VMICU'] },
  { id: 'stellar', name: 'Stellar', validAreas: ['9F', 'MICU', 'ER'] }
];

export default function App() {
  const [activeTab, setActiveTab] = useState('9F');
  const [inventory, setInventory] = useState({});
  const [isExporting, setIsExporting] = useState(false);
  const tableRef = useRef(null);

  // åˆå§‹åŒ–è³‡æ–™èˆ‡å‹•æ…‹è¼‰å…¥ html2canvas
  useEffect(() => {
    // è¼‰å…¥ html2canvas ä»¥æ”¯æ´åœ–ç‰‡åŒ¯å‡ºåŠŸèƒ½
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.async = true;
    document.body.appendChild(script);

    // åˆå§‹åŒ–åº«å­˜è³‡æ–™ (é è¨­ç‚º '0')
    const initialData = {};
    AREAS.forEach(area => {
      initialData[area] = {};
      ITEMS.forEach(item => {
        if (item.validAreas.includes(area)) {
          initialData[area][item.id] = '0';
        } else {
          initialData[area][item.id] = 'N/A';
        }
      });
    });
    
    // å˜—è©¦å¾ localStorage è®€å–æš«å­˜
    const savedData = localStorage.getItem('inventoryData');
    if (savedData) {
      setInventory(JSON.parse(savedData));
    } else {
      setInventory(initialData);
    }
  }, []);

  // ç•¶è³‡æ–™è®Šæ›´æ™‚ï¼Œè‡ªå‹•å„²å­˜åˆ° localStorage
  useEffect(() => {
    if (Object.keys(inventory).length > 0) {
      localStorage.setItem('inventoryData', JSON.stringify(inventory));
    }
  }, [inventory]);

  const handleInputChange = (area, itemId, value) => {
    setInventory(prev => ({
      ...prev,
      [area]: {
        ...prev[area],
        [itemId]: value
      }
    }));
  };

  const appendStatus = (area, itemId, statusStr) => {
    setInventory(prev => {
      let currentVal = prev[area][itemId];
      if (currentVal === '0' || currentVal === '') {
        currentVal = `0${statusStr}`;
      } else {
        currentVal = `${currentVal}${statusStr}`;
      }
      return {
        ...prev,
        [area]: {
          ...prev[area],
          [itemId]: currentVal
        }
      };
    });
  };

  const clearData = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é»ç­ç´€éŒ„å—ï¼Ÿ')) {
      const resetData = { ...inventory };
      AREAS.forEach(area => {
        ITEMS.forEach(item => {
          if (item.validAreas.includes(area)) {
            resetData[area][item.id] = '0';
          }
        });
      });
      setInventory(resetData);
      localStorage.removeItem('inventoryData');
    }
  };

  const exportAsImage = async () => {
    if (!window.html2canvas) {
      alert('åœ–ç‰‡ç”Ÿæˆæ¨¡çµ„è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      return;
    }
    
    setIsExporting(true);
    try {
      // æ“·å–è¡¨æ ¼ç‚º Canvas
      const canvas = await window.html2canvas(tableRef.current, {
        scale: 2, // æé«˜è§£æåº¦
        backgroundColor: '#ffffff'
      });
      
      // è½‰æ›ç‚ºåœ–ç‰‡ç¶²å€ä¸¦ä¸‹è¼‰
      const image = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = image;
      const date = new Date();
      const dateString = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥_${date.getHours()}æ™‚${date.getMinutes()}åˆ†`;
      link.download = `ç©ºæ©Ÿé»ç­çµ±è¨ˆ_${dateString}.png`;
      link.click();
    } catch (err) {
      console.error('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—:', err);
      alert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    } finally {
      setIsExporting(false);
    }
  };

  if (Object.keys(inventory).length === 0) return <div className="p-4 text-center">è¼‰å…¥ä¸­...</div>;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">
      {/* é ‚éƒ¨å°è¦½åˆ— */}
      <header className="bg-blue-700 text-white shadow-md sticky top-0 z-20">
        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <ClipboardList size={24} />
            <h1 className="text-xl font-bold tracking-wider">å‘¼å¸å™¨ç©ºæ©Ÿé»ç­ç³»çµ±</h1>
          </div>
          <button 
            onClick={clearData}
            className="text-blue-200 hover:text-white flex items-center gap-1 text-sm bg-blue-800 px-3 py-1.5 rounded-lg transition"
          >
            <XCircle size={16} />
            æ¸…ç©º
          </button>
        </div>
        
        {/* æ¨™ç±¤é åˆ‡æ› */}
        <div className="flex overflow-x-auto hide-scrollbar border-t border-blue-600">
          {AREAS.map(area => (
            <button
              key={area}
              onClick={() => setActiveTab(area)}
              className={`flex-1 py-3 px-4 min-w-[80px] text-center font-medium border-b-4 transition-colors ${
                activeTab === area ? 'border-white bg-blue-800 text-white' : 'border-transparent text-blue-200 hover:bg-blue-600'
              }`}
            >
              {area}
            </button>
          ))}
          <button
            onClick={() => setActiveTab('SUMMARY')}
            className={`flex-1 py-3 px-4 min-w-[100px] text-center font-medium border-b-4 transition-colors ${
              activeTab === 'SUMMARY' ? 'border-yellow-400 bg-blue-800 text-yellow-400' : 'border-transparent text-blue-200 hover:bg-blue-600'
            }`}
          >
            ç¸½è¡¨é è¦½
          </button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 mt-2">
        {/* å€åŸŸé»ç­è¼¸å…¥å€ */}
        {AREAS.includes(activeTab) && (
          <div className="space-y-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center mb-6">
              <div>
                <h2 className="text-lg font-bold text-slate-700">ç›®å‰å€åŸŸï¼š{activeTab}</h2>
                <p className="text-sm text-slate-500">åƒ…é¡¯ç¤ºè©²å€åŸŸéœ€é»ç­ä¹‹å„€å™¨</p>
              </div>
              <CheckCircle2 className="text-green-500" size={32} opacity={0.2} />
            </div>

            <div className="grid gap-4 md:grid-cols-2">
              {ITEMS.filter(item => item.validAreas.includes(activeTab)).map(item => (
                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-3">
                  <label className="font-semibold text-lg text-slate-800 flex justify-between items-center">
                    {item.name}
                    {inventory[activeTab][item.id] === '0' && <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">æœªæœ‰ç•°å‹•</span>}
                  </label>
                  
                  <div className="flex gap-2 items-center">
                    <input
                      type="text"
                      value={inventory[activeTab][item.id]}
                      onChange={(e) => handleInputChange(activeTab, item.id, e.target.value)}
                      className="flex-1 text-xl font-bold p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    />
                  </div>
                  
                  {/* å¿«æ·æŒ‰éˆ• */}
                  <div className="flex flex-wrap gap-2 mt-1">
                    <button onClick={() => appendStatus(activeTab, item.id, '+1')} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md text-sm font-medium transition">
                      +1
                    </button>
                    <button onClick={() => appendStatus(activeTab, item.id, '+1(è«‹ä¿®)')} className="px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-700 rounded-md text-sm font-medium transition flex items-center gap-1">
                      <AlertCircle size={14} /> +1(è«‹ä¿®)
                    </button>
                    <button onClick={() => appendStatus(activeTab, item.id, '+1(è½‰é€)')} className="px-3 py-1.5 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-md text-sm font-medium transition">
                      +1(è½‰é€)
                    </button>
                    <button onClick={() => handleInputChange(activeTab, item.id, '0')} className="px-3 py-1.5 ml-auto text-slate-500 hover:text-slate-700 text-sm underline">
                      æ­¸é›¶
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ç¸½è¡¨é è¦½å€ */}
        {activeTab === 'SUMMARY' && (
          <div className="space-y-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
              <div>
                <h2 className="text-lg font-bold text-slate-800">é»ç­çµ±è¨ˆç¸½è¡¨</h2>
                <p className="text-sm text-slate-500">ç¢ºèªç„¡èª¤å¾Œå¯åŒ¯å‡ºåœ–ç‰‡åˆ†äº«</p>
              </div>
              <button 
                onClick={exportAsImage}
                disabled={isExporting}
                className="w-full sm:w-auto flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-md shadow-green-600/20 transition-all disabled:opacity-70"
              >
                {isExporting ? <span className="animate-pulse">ç”Ÿæˆä¸­...</span> : <><Camera size={20} /> å„²å­˜åœ–ç‰‡</>}
              </button>
            </div>

            {/* è¡¨æ ¼å®¹å™¨ (å¥—ç”¨èˆ‡åœ–ç‰‡å®Œå…¨ç›¸åŒçš„æ¨£å¼) */}
            <div className="overflow-x-auto bg-white p-2 rounded-xl shadow-sm border border-slate-200">
              <div ref={tableRef} className="p-4 bg-white min-w-[600px]">
                <table className="w-full border-collapse border-2 border-slate-800 text-center font-sans">
                  <thead>
                    <tr>
                      <th className="border border-slate-800 p-2 bg-slate-100 font-bold text-slate-800 w-1/5">ç©ºæ©Ÿçµ±è¨ˆ</th>
                      {AREAS.map(area => (
                        <th key={area} className="border border-slate-800 p-2 bg-slate-100 font-bold text-slate-800 w-1/5">{area}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {ITEMS.map(item => (
                      <tr key={item.id}>
                        <td className={`border border-slate-800 p-2 font-medium text-left ${item.isYellow ? 'bg-amber-400' : 'bg-white'}`}>
                          {item.name}
                        </td>
                        {AREAS.map(area => {
                          const val = inventory[area]?.[item.id];
                          const isNA = val === 'N/A';
                          return (
                            <td 
                              key={`${area}-${item.id}`} 
                              className={`border border-slate-800 p-2 ${isNA ? 'bg-gray-300 text-slate-500' : 'bg-white text-slate-900 font-medium'}`}
                            >
                              {val}
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
            
            {/* æç¤ºèªªæ˜ */}
            <div className="bg-blue-50 text-blue-800 p-4 rounded-xl text-sm leading-relaxed border border-blue-100">
              ğŸ’¡ <strong>æ“ä½œæç¤ºï¼š</strong><br />
              1. é»æ“Šä¸Šæ–¹çš„å€åŸŸæ¨™ç±¤ï¼ˆ9F, MICU...ï¼‰ä¾†é€²è¡Œå„å€çš„é»ç­ã€‚<br />
              2. è¼¸å…¥æ¬„ä½æ”¯æ´æ–‡å­—ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¼¸å…¥å¦‚ <code>4+1(è«‹ä¿®)</code>ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹çš„å¿«æ·æŒ‰éˆ•ã€‚<br />
              3. æ‰€æœ‰è³‡æ–™æœƒè‡ªå‹•æš«å­˜åœ¨ç€è¦½å™¨ä¸­ï¼Œä¸å°å¿ƒé—œé–‰ç¶²é ä¹Ÿä¸æœƒæ¶ˆå¤±ã€‚<br />
              4. é»æ“Šã€Œå„²å­˜åœ–ç‰‡ã€å³å¯å°‡è¡¨æ ¼è½‰ç‚º PNG åœ–ç‰‡ä¸‹è¼‰ã€‚
            </div>
          </div>
        )}
      </main>
      
      {/* éš±è—æ»¾å‹•æ¢çš„ CSS */}
      <style dangerouslySetInnerHTML={{__html: `
        .hide-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .hide-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      `}} />
    </div>
  );
}


