<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼吸道藥物階層式衛教檢索</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }

        /* 主標籤動效 */
        .main-tab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .main-tab.active {
            background-color: #0f172a;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        /* 次標籤樣式 */
        .sub-tab {
            transition: all 0.2s ease;
        }
        .sub-tab.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* 卡片設計與懸停 */
        .med-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (min-width: 768px) {
            .med-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }

        /* 藥理分類配色條 */
        .border-laba-ics { border-left: 5px solid #818cf8; }
        .border-laba-lama { border-left: 5px solid #10b981; }
        .border-lama { border-left: 5px solid #06b6d4; }
        .border-triple { border-left: 5px solid #f43f5e; }
        .border-saba { border-left: 5px solid #f59e0b; }
        .border-ics { border-left: 5px solid #f472b6; }
        .border-others { border-left: 5px solid #94a3b8; }

        /* 滾動條隱藏 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* SVG 插畫特效 */
        .svg-container {
            perspective: 1000px;
        }
        .svg-device {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.1));
        }
        .med-card:hover .svg-device {
            transform: rotateY(-10deg) rotateX(5deg) scale(1.1);
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl md:text-5xl font-black text-slate-800 mb-2 tracking-tight">呼吸道藥物 ‧ 圖鑑檢索</h1>
            <p class="text-slate-500 font-medium">基於臨床手冊繪製的高擬真吸入器視覺指南</p>
        </header>

        <!-- 篩選區 Step 1 -->
        <div class="mb-6">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 text-center">Step 1. 裝置類型分類</p>
            <div class="flex flex-nowrap md:flex-wrap justify-start md:justify-center gap-3 overflow-x-auto pb-4 hide-scrollbar" id="mainTabs">
                <button class="main-tab active px-6 py-3 rounded-2xl font-black bg-white text-slate-600 shadow-sm border border-slate-200 flex-shrink-0" data-main="all">全部裝置</button>
                <button class="main-tab px-6 py-3 rounded-2xl font-black bg-white text-slate-600 shadow-sm border border-slate-200 flex-shrink-0" data-main="smi">SMI 舒沛噴</button>
                <button class="main-tab px-6 py-3 rounded-2xl font-black bg-white text-slate-600 shadow-sm border border-slate-200 flex-shrink-0" data-main="dpi">DPI 乾粉型</button>
                <button class="main-tab px-6 py-3 rounded-2xl font-black bg-white text-slate-600 shadow-sm border border-slate-200 flex-shrink-0" data-main="mdi">MDI 定量型</button>
                <button class="main-tab px-6 py-3 rounded-2xl font-black bg-white text-slate-600 shadow-sm border border-slate-200 flex-shrink-0" data-main="nasal">鼻噴劑</button>
            </div>
        </div>

        <!-- 篩選區 Step 2 -->
        <div class="mb-8">
            <div class="flex flex-nowrap md:flex-wrap justify-start md:justify-center gap-2 overflow-x-auto pb-2 hide-scrollbar" id="subTabs">
                <button class="sub-tab active px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="all">不限藥理</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="LABA+ICS">LABA + ICS</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="LABA+LAMA">LABA + LAMA</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="LAMA">LAMA</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="Triple">三合一 (Triple)</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="SABA">SABA (急救)</button>
                <button class="sub-tab px-4 py-1.5 rounded-full text-xs font-bold border border-slate-300 text-slate-500 flex-shrink-0" data-sub="ICS">ICS (單方)</button>
            </div>
        </div>

        <!-- 搜尋與下拉選單 -->
        <div class="max-w-xl mx-auto mb-10 space-y-4 px-2">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="搜尋商品名、中文名或成分..." 
                       class="w-full pl-12 pr-4 py-4 bg-white border-none rounded-3xl shadow-md focus:ring-2 focus:ring-blue-500 outline-none text-base font-medium">
                <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </span>
            </div>
            <select id="drugSelect" class="w-full px-5 py-4 bg-white border-none rounded-3xl shadow-md focus:ring-2 focus:ring-blue-500 outline-none text-base appearance-none cursor-pointer font-bold text-slate-700">
                <option value="">快速挑選藥物...</option>
            </select>
        </div>

        <!-- 網格渲染區 -->
        <div id="medicineGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
            <!-- 動態渲染 -->
        </div>

        <!-- 無結果顯示 -->
        <div id="noResults" class="hidden text-center py-24">
            <div class="inline-block p-6 bg-slate-100 rounded-full mb-4">
                <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 9.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <p class="text-xl text-slate-400 font-black">找不到符合條件的藥物</p>
        </div>
    </div>

    <!-- 影片播放 Modal -->
    <div id="videoModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
        <div class="bg-black rounded-[2rem] overflow-hidden w-full max-w-4xl relative shadow-2xl">
            <button onclick="closeVideo()" class="absolute top-6 right-6 text-white bg-white/10 p-2 rounded-full hover:bg-red-500 transition-colors z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <video id="modalPlayer" controls class="w-full aspect-video"></video>
        </div>
    </div>

    <!-- 全螢幕 QR Code 放大 Modal -->
    <div id="qrModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-sm animate-in fade-in duration-300">
        <div class="w-full max-w-sm bg-white rounded-[2.5rem] p-8 flex flex-col items-center shadow-2xl relative">
            <button onclick="closeQRModal()" class="absolute top-4 right-4 p-2 text-slate-300 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div id="qrModalContent" class="text-center w-full">
                <p id="qrDrugName" class="text-xl font-black text-slate-800 mb-1 leading-tight">藥物名稱</p>
                <p class="text-xs font-bold text-blue-500 mb-6 tracking-widest uppercase">掃描觀看衛教影片</p>
                
                <div class="bg-white p-4 rounded-3xl shadow-inner border border-slate-50 mb-8 mx-auto flex items-center justify-center">
                    <img id="qrFullImage" src="" class="w-56 h-56 md:w-72 md:h-72 object-contain" alt="QR Code">
                </div>
                
                <button onclick="closeQRModal()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black tracking-widest active:scale-95 transition">
                    關閉視窗
                </button>
            </div>
        </div>
    </div>

    <script>
        // 完整的藥物清單
        const medicines = [
            // SMI (Respimat)
            { main: 'smi', sub: 'LAMA', name: 'Spiriva', cn: '適喘樂', ing: 'Tiotropium', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB057E20230817171041.mp4' },
            { main: 'smi', sub: 'LABA', name: 'Striverdi', cn: '斯力瑞', ing: 'Olodaterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB057E20230817171041.mp4' },
            { main: 'smi', sub: 'LABA+LAMA', name: 'Spiolto', cn: '適倍樂', ing: 'Tiotropium / Olodaterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB057E20230817171041.mp4' },

            // DPI - Breezhaler & Ellipta & Turbuhaler & Accuhaler
            { main: 'dpi', sub: 'LAMA', name: 'Seebri (Breezhaler)', cn: '喜必樂', ing: 'Glycopyrronium', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB052E20230817165536.mp4' },
            { main: 'dpi', sub: 'LABA', name: 'Onbrez (Breezhaler)', cn: '昂舒', ing: 'Indacaterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB052E20230817165536.mp4' },
            { main: 'dpi', sub: 'LABA+LAMA', name: 'Ultibro (Breezhaler)', cn: '昂必樂', ing: 'Indacaterol / Glycopyrronium', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB052E20230817165536.mp4' },
            { main: 'dpi', sub: 'LABA+LAMA', name: 'Anoro (Ellipta)', cn: '安通樂', ing: 'Umeclidinium / Vilanterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB056E20250116120821.mp4' },
            { main: 'dpi', sub: 'LABA+ICS', name: 'Relvar (Ellipta)', cn: '瑞克沙', ing: 'Fluticasone / Vilanterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB056E20250116120821.mp4' },
            { main: 'dpi', sub: 'LABA+ICS', name: 'Seretide (Accuhaler)', cn: '使肺泰 準納', ing: 'Salmeterol / Fluticasone', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA009E20230914192800.mp4' },
            { main: 'dpi', sub: 'LABA+ICS', name: 'Symbicort (Turbuhaler)', cn: '吸必擴 都保', ing: 'Budesonide / Formoterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA005E20230817090020.mp4' },
            { main: 'dpi', sub: 'Triple', name: 'Trelegy (Ellipta)', cn: '喘立氣', ing: 'Fluticasone / Umeclidinium / Vilanterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB056E20250116120821.mp4' },
            { main: 'dpi', sub: 'Triple', name: 'Enerzair (Breezhaler)', cn: '肺舒坦', ing: 'Indacaterol / Glycopyrronium / Mometasone', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB066E20250919154133.mp4' },

            // MDI
            { main: 'mdi', sub: 'LABA+LAMA', name: 'Bevespi', cn: '比倍思', ing: 'Glycopyrronium / Formoterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB065E20231023173208.mp4' },
            { main: 'mdi', sub: 'LABA+ICS', name: 'Seretide (Evohaler)', cn: '使肺泰 定量', ing: 'Salmeterol / Fluticasone', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA013E20250917153840.mp4' },
            { main: 'mdi', sub: 'LABA+ICS', name: 'Symbicort (Rapihaler)', cn: '吸必擴 定量', ing: 'Budesonide / Formoterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA058E20230914191940.mp4' },
            { main: 'mdi', sub: 'LABA+ICS', name: 'Foster', cn: '複方定量', ing: 'Beclometasone / Formoterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA034E20240119095130.mp4' },
            { main: 'mdi', sub: 'Triple', name: 'Trimbow', cn: '全盈', ing: 'Beclometasone / Formoterol / Glycopyrronium', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB063E20231023172741.mp4' },
            { main: 'mdi', sub: 'SABA', name: 'Ventolin', cn: '萬托林', ing: 'Salbutamol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB054E20231023172513.mp4' },
            { main: 'mdi', sub: 'SABA', name: 'Berotec', cn: '備勞喘', ing: 'Fenoterol', video: 'https://webapp.cgmh.org.tw/stor/picture/PQB015E20231023172308.mp4' },
            { main: 'mdi', sub: 'ICS', name: 'Alvesco', cn: '安肺樂', ing: 'Ciclesonide', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA054E20240119095228.mp4' },
            { main: 'mdi', sub: 'ICS', name: 'Duasma', cn: '多適碼', ing: 'Budesonide', video: 'https://webapp.cgmh.org.tw/stor/picture/PMA007E20231122133102.mp4' },

            // 鼻噴劑
            { main: 'nasal', sub: 'Others', name: 'Avamys', cn: '艾敏釋', ing: 'Fluticasone furoate', video: 'https://webapp.cgmh.org.tw/stor/picture/PVA052E20241213175133.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Nasonex', cn: '內舒拿', ing: 'Mometasone furoate', video: 'https://webapp.cgmh.org.tw/stor/picture/PVA100E20241213180811.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Tisonin', cn: '特索寧', ing: 'Triamcinolone', video: 'https://webapp.cgmh.org.tw/stor/picture/PVA001E20241213165924.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Dufanas', cn: '帝伏寧', ing: 'Azelastine / Fluticasone', video: 'https://webapp.cgmh.org.tw/stor/picture/PVA114E20241213173056.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Azetin', cn: '噴立停', ing: 'Azelastine', video: 'https://webapp.cgmh.org.tw/stor/picture/PVA106E20241213171944.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Allergocom', cn: '艾麗', ing: 'Cromolyn', video: 'https://webapp.cgmh.org.tw/stor/picture/PZA014E20241213173753.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Sindecon', cn: '醫鼻易', ing: 'Oxymetazoline', video: 'https://webapp.cgmh.org.tw/stor/picture/PVG010E20241213174519.mp4' },
            { main: 'nasal', sub: 'Others', name: 'Butaxo', cn: '全安', ing: 'Butorphanol', video: 'https://webapp.cgmh.org.tw/stor/picture/017.mp4' }
        ];

        // 為確保 SVG 百分之百顯示，將定義（漸層與濾鏡）直接嵌入每一個生成的 SVG 內
        const svgDefs = `
            <defs>
                <filter id="mainShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="#000" flood-opacity="0.2" />
                </filter>
                <linearGradient id="gradMetal" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#94a3b8" />
                    <stop offset="30%" stop-color="#f8fafc" />
                    <stop offset="60%" stop-color="#cbd5e1" />
                    <stop offset="100%" stop-color="#64748b" />
                </linearGradient>
                <linearGradient id="gradPlastic" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#ffffff" />
                    <stop offset="100%" stop-color="#e2e8f0" />
                </linearGradient>
                <linearGradient id="gradGlass" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="rgba(255,255,255,0.8)" />
                    <stop offset="100%" stop-color="rgba(203,213,225,0.4)" />
                </linearGradient>
            </defs>
        `;

        const DeviceRenderer = {
            SMI(color) {
                return `
                <g filter="url(#mainShadow)">
                    <path d="M35 15 h30 a5 5 0 0 1 5 5 v20 h-40 v-20 a5 5 0 0 1 5 -5z" fill="${color}"/>
                    <rect x="35" y="15" width="5" height="25" fill="#fff" opacity="0.3"/>
                    <rect x="30" y="40" width="40" height="8" fill="#94a3b8"/>
                    <rect x="38" y="50" width="24" height="30" rx="2" fill="url(#gradMetal)"/>
                    <path d="M30 48 h40 v35 a5 5 0 0 1-5 5 h-30 a5 5 0 0 1-5-5z" fill="url(#gradGlass)" stroke="#cbd5e1" stroke-width="1.5"/>
                    <rect x="46" y="55" width="8" height="18" fill="#fff" stroke="#94a3b8" stroke-width="1"/>
                    <line x1="46" y1="64" x2="54" y2="64" stroke="#ef4444" stroke-width="2"/>
                </g>`;
            },
            Ellipta(color) {
                return `
                <g filter="url(#mainShadow)">
                    <ellipse cx="50" cy="52" rx="42" ry="38" fill="url(#gradPlastic)"/>
                    <path d="M8 42 h22 v18 h-22 a5 5 0 0 1-5-5 v-8 a5 5 0 0 1 5-5z" fill="#f1f5f9" stroke="#cbd5e1"/>
                    <path d="M50 14 a42 38 0 0 1 42 38 a42 38 0 0 1-42 38z" fill="${color}"/>
                    <path d="M68 32 Q 80 52 68 72" fill="none" stroke="#000" stroke-opacity="0.1" stroke-width="4" stroke-linecap="round"/>
                    <path d="M76 38 Q 86 52 76 66" fill="none" stroke="#000" stroke-opacity="0.1" stroke-width="4" stroke-linecap="round"/>
                    <rect x="62" y="48" width="16" height="10" rx="2" fill="#1e293b"/>
                    <text x="70" y="56" fill="#10b981" font-size="8" font-weight="900" text-anchor="middle" font-family="sans-serif">30</text>
                </g>`;
            },
            Turbuhaler(baseColor) {
                return `
                <g filter="url(#mainShadow)">
                    <path d="M38 10 h24 l2 20 h-28z" fill="#fff" stroke="#cbd5e1"/>
                    <rect x="35" y="30" width="30" height="38" fill="url(#gradPlastic)"/>
                    <path d="M35 68 h30 v16 a4 4 0 0 1-4 4 h-22 a4 4 0 0 1-4-4z" fill="${baseColor}"/>
                    <rect x="40" y="10" width="4" height="78" fill="#fff" opacity="0.4"/>
                    <rect x="39" y="68" width="22" height="2" fill="#000" opacity="0.1"/>
                    <rect x="42" y="70" width="2" height="18" fill="#000" opacity="0.1"/>
                    <rect x="56" y="70" width="2" height="18" fill="#000" opacity="0.1"/>
                </g>`;
            },
            MDI(bodyColor, capColor) {
                return `
                <g filter="url(#mainShadow)">
                    <rect x="52" y="8" width="24" height="52" rx="4" fill="url(#gradMetal)"/>
                    <path d="M46 36 h34 v46 a12 12 0 0 1-12 12 h-44 a12 12 0 0 1-12-12 v-24 a12 12 0 0 1 12-12 h22z" fill="${bodyColor}"/>
                    <rect x="48" y="36" width="6" height="40" fill="#fff" opacity="0.15"/>
                    <path d="M12 60 h20 v32 h-20 a6 6 0 0 1-6-6 v-20 a6 6 0 0 1 6-6z" fill="${capColor}"/>
                    <path d="M14 62 h4 v28 h-4z" fill="#fff" opacity="0.2"/>
                </g>`;
            },
            Breezhaler(btnColor) {
                return `
                <g filter="url(#mainShadow)">
                    <path d="M42 12 h16 l-2 22 h-12z" fill="#fff" stroke="#cbd5e1"/>
                    <rect x="25" y="50" width="10" height="22" rx="4" fill="${btnColor}"/>
                    <rect x="65" y="50" width="10" height="22" rx="4" fill="${btnColor}"/>
                    <path d="M30 34 h40 v38 a15 15 0 0 1-15 15 h-10 a15 15 0 0 1-15-15z" fill="url(#gradPlastic)"/>
                    <circle cx="50" cy="62" r="14" fill="#f1f5f9" stroke="#cbd5e1"/>
                    <rect x="45" y="56" width="10" height="12" rx="5" fill="#ef4444" opacity="0.7"/>
                </g>`;
            },
            Accuhaler(color) {
                return `
                <g filter="url(#mainShadow)">
                    <circle cx="50" cy="50" r="42" fill="${color}"/>
                    <path d="M50 8 a42 42 0 0 1 42 42 h-42z" fill="#c084fc"/>
                    <path d="M82 38 h12 v24 h-12 a4 4 0 0 1-4-4 v-16 a4 4 0 0 1 4-4z" fill="#fff" stroke="#cbd5e1"/>
                    <rect x="40" y="46" width="16" height="8" rx="1" fill="#fff"/>
                    <text x="48" y="53" fill="#000" font-size="7" font-weight="900" text-anchor="middle">60</text>
                    <ellipse cx="72" cy="50" rx="12" ry="6" fill="#000" opacity="0.2"/>
                </g>`;
            },
            Nasal(labelColor) {
                return `
                <g filter="url(#mainShadow)">
                    <rect x="47" y="30" width="6" height="15" fill="#cbd5e1"/>
                    <path d="M44 8 l-2 25 h16 l-2-25z" fill="#fff" stroke="#e2e8f0"/>
                    <rect x="30" y="33" width="40" height="8" rx="4" fill="#fff" stroke="#cbd5e1"/>
                    <path d="M34 42 h32 c8 0 10 4 10 12 v28 c0 6-4 10-10 10 h-32 c-6 0-10-4-10-10 v-28 c0-8 2-12 10-12z" fill="url(#gradPlastic)"/>
                    <rect x="28" y="55" width="44" height="28" fill="${labelColor}"/>
                    <rect x="32" y="60" width="12" height="4" fill="#fff" opacity="0.4" rx="2"/>
                </g>`;
            },
            Default() {
                return `<rect x="30" y="20" width="40" height="60" rx="10" fill="#e2e8f0" stroke="#cbd5e1"/>`;
            }
        };

        function getDeviceSVG(med) {
            const name = med.name.toLowerCase();
            const main = med.main.toLowerCase();
            
            let content = '';
            
            if (main === 'smi') {
                let c = '#0ea5e9';
                if (name.includes('spiolto')) c = '#84cc16';
                if (name.includes('striverdi')) c = '#a3e635';
                content = DeviceRenderer.SMI(c);
            } 
            else if (main === 'mdi') {
                let b = '#475569', c = '#cbd5e1';
                if (name.includes('ventolin')) { b = '#0d9488'; c = '#0f766e'; }
                if (name.includes('symbicort')) { b = '#ef4444'; c = '#fee2e2'; }
                if (name.includes('trimbow')) { b = '#e11d48'; c = '#ffe4e6'; }
                content = DeviceRenderer.MDI(b, c);
            } 
            else if (main === 'dpi') {
                if (name.includes('ellipta') || name.includes('anoro') || name.includes('relvar') || name.includes('trelegy')) {
                    let c = '#cbd5e1';
                    if (name.includes('anoro')) c = '#ef4444';
                    if (name.includes('relvar')) c = '#eab308';
                    content = DeviceRenderer.Ellipta(c);
                } else if (name.includes('turbuhaler') || name.includes('symbicort')) {
                    content = DeviceRenderer.Turbuhaler('#ef4444');
                } else if (name.includes('breezhaler') || name.includes('seebri') || name.includes('onbrez') || name.includes('ultibro') || name.includes('enerzair')) {
                    let c = '#f97316';
                    if (name.includes('ultibro')) c = '#eab308';
                    if (name.includes('enerzair')) c = '#10b981';
                    if (name.includes('onbrez')) c = '#1e293b';
                    content = DeviceRenderer.Breezhaler(c);
                } else if (name.includes('accuhaler') || name.includes('seretide')) {
                    content = DeviceRenderer.Accuhaler('#9333ea');
                } else {
                    content = DeviceRenderer.Default();
                }
            } 
            else if (main === 'nasal') {
                let c = '#3b82f6';
                if (name.includes('nasonex')) c = '#10b981';
                if (name.includes('tisonin')) c = '#f59e0b';
                if (name.includes('dufanas')) c = '#8b5cf6';
                if (name.includes('azetin')) c = '#ef4444';
                if (name.includes('allergocom')) c = '#6366f1';
                if (name.includes('sindecon')) c = '#0ea5e9';
                if (name.includes('butaxo')) c = '#475569';
                content = DeviceRenderer.Nasal(c);
            } 
            else {
                content = DeviceRenderer.Default();
            }

            // 確保每次渲染 SVG 時，都包含定義好的 defs，徹底解決圖形消失的問題！
            return `
                <svg viewBox="0 0 100 100" class="svg-device w-full h-full max-w-[110px] max-h-[110px] object-contain">
                    ${svgDefs}
                    ${content}
                </svg>
            `;
        }

        let state = { main: 'all', sub: 'all', search: '' };

        function render() {
            const grid = document.getElementById('medicineGrid');
            const noResults = document.getElementById('noResults');
            
            const filtered = medicines.filter(m => {
                const matchMain = state.main === 'all' || m.main === state.main;
                const matchSub = state.sub === 'all' || m.sub === state.sub;
                const matchSearch = m.name.toLowerCase().includes(state.search.toLowerCase()) || 
                                   m.cn.includes(state.search) || 
                                   m.ing.toLowerCase().includes(state.search.toLowerCase());
                return matchMain && matchSub && matchSearch;
            });

            const select = document.getElementById('drugSelect');
            select.innerHTML = '<option value="">快速挑選藥物...</option>';
            [...new Set(filtered.map(m => m.name))].sort().forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.textContent = n;
                if (state.search === n) opt.selected = true;
                select.appendChild(opt);
            });

            if (filtered.length === 0) {
                grid.innerHTML = ''; noResults.classList.remove('hidden'); return;
            }

            noResults.classList.add('hidden');
            grid.innerHTML = filtered.map(m => `
                <div class="med-card bg-white p-4 md:p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col h-full ${getBorderClass(m.sub)} cursor-default">
                    
                    <div class="mb-5 rounded-[1.5rem] bg-slate-50 relative aspect-square flex items-center justify-center border border-slate-100 overflow-visible svg-container">
                        ${getDeviceSVG(m)}
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <span class="text-[9px] font-black px-2 py-0.5 bg-slate-100 rounded-lg text-slate-400 uppercase tracking-tighter">${m.main}</span>
                        <span class="text-[9px] font-bold px-2 py-0.5 bg-blue-50 text-blue-500 rounded-lg uppercase tracking-tighter">${m.sub}</span>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg md:text-xl font-black text-slate-800 leading-tight truncate">${m.name}</h3>
                        <p class="text-blue-600 font-bold text-sm md:text-base truncate">${m.cn}</p>
                    </div>
                    
                    <div class="mb-6 flex-grow">
                        <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">成分組成</p>
                        <p class="text-xs md:text-sm text-slate-500 font-medium leading-snug">${m.ing}</p>
                    </div>
                    
                    <!-- 按鈕並排區塊 (影片與掃碼) -->
                    <div class="mt-auto flex gap-2 pt-2 border-t border-slate-50">
                        <button onclick="openVideo('${m.video}')" class="flex-1 bg-red-500 text-white py-2.5 md:py-3 rounded-2xl text-xs md:text-base font-black flex items-center justify-center gap-1.5 hover:bg-red-600 transition-all shadow-sm active:scale-95">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                            影片
                        </button>
                        <button onclick="openQRModal('${m.name}', '${m.video}')" class="flex-1 bg-slate-800 text-white py-2.5 md:py-3 rounded-2xl text-xs md:text-base font-black flex items-center justify-center gap-1.5 hover:bg-slate-900 transition-all shadow-sm active:scale-95">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                            掃碼
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getBorderClass(sub) {
            const map = { 'LABA+ICS': 'border-laba-ics', 'LABA+LAMA': 'border-laba-lama', 'LAMA': 'border-lama', 'Triple': 'border-triple', 'SABA': 'border-saba', 'ICS': 'border-ics' };
            return map[sub] || 'border-others';
        }

        function openVideo(url) {
            const p = document.getElementById('modalPlayer');
            p.src = url;
            document.getElementById('videoModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            p.play();
        }

        function closeVideo() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('modalPlayer').pause();
            document.body.style.overflow = 'auto';
        }

        function openQRModal(name, videoUrl) {
            const modal = document.getElementById('qrModal');
            const qrImg = document.getElementById('qrFullImage');
            const nameLabel = document.getElementById('qrDrugName');
            
            nameLabel.textContent = name;
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(videoUrl)}`;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        document.getElementById('mainTabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.main-tab').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.main = e.target.dataset.main; render();
            }
        });

        document.getElementById('subTabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.sub = e.target.dataset.sub; render();
            }
        });

        document.getElementById('searchInput').addEventListener('input', (e) => { state.search = e.target.value; render(); });
        document.getElementById('drugSelect').addEventListener('change', (e) => { state.search = e.target.value; document.getElementById('searchInput').value = e.target.value; render(); });

        window.onclick = (e) => { 
            if (e.target == document.getElementById('videoModal')) closeVideo(); 
            if (e.target == document.getElementById('qrModal')) closeQRModal();
        };
        window.onload = render;
    </script>
</body>
</html>
