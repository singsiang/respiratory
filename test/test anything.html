<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å‘¼å¸å™¨ç©ºæ©Ÿé»ç­ç³»çµ±</title>
  <!-- å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ React èˆ‡ ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- å¼•å…¥ Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- å¼•å…¥ html2canvas ç”¨æ–¼åŒ¯å‡ºåœ–ç‰‡ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒå¯ä»¥æ»¾å‹• */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* é˜²æ­¢æ‰‹æ©Ÿé»æ“Šé–ƒçˆ */
    body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; overflow-x: hidden; }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    /* å ±è¡¨å°ˆå±¬å­—é«”è¨­å®šï¼Œç¢ºä¿è¼¸å‡ºåœ–ç‰‡å­—é«”èˆ‡ Excel ç›¸è¿‘ */
    .report-table {
      font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
    }
    
    /* è‡ªè¨‚æ»¾å‹•æ¢æ¨£å¼çµ¦ Textarea */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-24 w-full">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- SVG åœ–ç¤ºå…ƒä»¶ ---
    const IconClipboard = ({className="w-5 h-5 sm:w-6 sm:h-6"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>;
    const IconCamera = ({className="w-5 h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
    const IconCheck = ({className="w-6 h-6 sm:w-8 sm:h-8"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>;
    const IconX = ({className="w-3.5 h-3.5 sm:w-4 sm:h-4"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
    const IconPlus = ({className="w-4 h-4 sm:w-5 sm:h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const IconMinus = ({className="w-4 h-4 sm:w-5 sm:h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const IconFileText = ({className="w-5 h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
    const IconCopy = ({className="w-5 h-5"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
    const IconInfo = ({className="w-4 h-4"}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;

    // --- è³‡æ–™æ¨¡å‹ ---
    const AREAS = ['9F', 'MICU', 'ER', 'VMICU'];
    const ITEMS = [
      { id: 'po_por', name: 'PO(por)', validAreas: ['VMICU'], isYellow: true },
      { id: 'po_nt1d', name: 'PO(NT1D)', validAreas: ['9F', 'VMICU'], isYellow: true },
      { id: 'savina', name: 'Savina', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'savina300', name: 'Savina300', validAreas: ['9F', 'MICU'] },
      { id: 'v600', name: 'V600', validAreas: ['9F', 'MICU'] },
      { id: 'servo300', name: 'Servo300', validAreas: ['9F'] },
      { id: 'galileo', name: 'Galileo', validAreas: ['9F'] },
      { id: 'dura', name: 'Dura', validAreas: ['MICU'] },
      { id: 'evita4', name: 'Evita-4', validAreas: ['MICU', 'VMICU'] },
      { id: 'po', name: 'PO', validAreas: ['9F'] },
      { id: 'nonin', name: 'Nonin', validAreas: ['9F'] },
      { id: 'hfnc', name: 'HFNC(AirVO2)', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'flexo', name: 'Flexo', validAreas: ['9F', 'MICU', 'ER', 'VMICU'] },
      { id: 'trilogy', name: 'Trilogy', validAreas: ['VMICU'] },
      { id: 'stellar', name: 'Stellar', validAreas: ['9F', 'MICU', 'ER'] }
    ];

    function App() {
      const [activeTab, setActiveTab] = useState('9F');
      const [inventory, setInventory] = useState({});
      const [focusedItem, setFocusedItem] = useState(null); 
      const [isExporting, setIsExporting] = useState(false);
      const [modal, setModal] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
      const [mdModal, setMdModal] = useState({ isOpen: false, content: '', title: '' });
      const [currentTimeStr, setCurrentTimeStr] = useState('');
      const tableRef = useRef(null);

      useEffect(() => {
        const initialData = {};
        AREAS.forEach(area => {
          initialData[area] = {};
          ITEMS.forEach(item => {
            initialData[area][item.id] = item.validAreas.includes(area) ? '0' : 'N/A';
          });
        });
        
        try {
          const savedData = localStorage.getItem('hospital_inventory_v6');
          if (savedData) setInventory(JSON.parse(savedData));
          else setInventory(initialData);
        } catch (e) {
          setInventory(initialData);
        }
      }, []);

      useEffect(() => {
        if (Object.keys(inventory).length > 0) {
          localStorage.setItem('hospital_inventory_v6', JSON.stringify(inventory));
        }
      }, [inventory]);

      // æ›´æ–°çµ±è¨ˆæ™‚é–“
      useEffect(() => {
        const updateTime = () => {
          const now = new Date();
          const pad = (n) => n.toString().padStart(2, '0');
          setCurrentTimeStr(`${now.getFullYear()}/${pad(now.getMonth() + 1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`);
        };
        updateTime();
        const timer = setInterval(updateTime, 60000);
        return () => clearInterval(timer);
      }, []);

      const showAlert = (message) => setModal({ isOpen: true, type: 'alert', message, onConfirm: null });
      const showConfirm = (message, onConfirm) => setModal({ isOpen: true, type: 'confirm', message, onConfirm });
      const closeModal = () => setModal({ isOpen: false, type: 'alert', message: '', onConfirm: null });

      const handleInputChange = (area, itemId, value) => {
        setInventory(prev => ({ ...prev, [area]: { ...prev[area], [itemId]: value } }));
        setFocusedItem(itemId);
      };

      const handleMainMathChange = (area, itemId, delta) => {
        setInventory(prev => {
          const currentStr = String(prev[area][itemId] || '0');
          const match = currentStr.match(/^(\d+)(.*)/);
          let num = 0;
          let rest = '';
          
          if (match) {
            num = parseInt(match[1], 10);
            rest = match[2];
          } else {
            rest = currentStr;
          }

          num = Math.max(0, num + delta);
          return { ...prev, [area]: { ...prev[area], [itemId]: `${num}${rest}` } };
        });
        setFocusedItem(itemId);
      };

      const handleStatusIncrease = (area, itemId, statusType) => {
         setInventory(prev => {
            const currentStr = String(prev[area][itemId] || '0');
            const regex = new RegExp(`\\+(\\d+)\\(${statusType}\\)`);
            const match = currentStr.match(regex);
            let newStr = '';

            if (match) {
              const currentStatusCount = parseInt(match[1], 10);
              const newStatusCount = currentStatusCount + 1;
              newStr = currentStr.replace(regex, `+${newStatusCount}(${statusType})`);
            } else {
              newStr = `${currentStr}+1(${statusType})`;
            }

            return { ...prev, [area]: { ...prev[area], [itemId]: newStr } };
         });
         setFocusedItem(itemId);
      };

      const handleResetItem = (area, itemId) => {
        setInventory(prev => ({ ...prev, [area]: { ...prev[area], [itemId]: '0' } }));
        setFocusedItem(itemId);
      };

      const requestClearData = () => {
        showConfirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é»ç­ç´€éŒ„å—ï¼Ÿæ‰€æœ‰æ•¸å­—èˆ‡è¨»è¨˜å°‡æœƒæ­¸é›¶ã€‚', () => {
          const resetData = { ...inventory };
          AREAS.forEach(area => {
            ITEMS.forEach(item => {
              if (item.validAreas.includes(area)) resetData[area][item.id] = '0';
            });
          });
          setInventory(resetData);
          setFocusedItem(null);
          showAlert('è³‡æ–™å·²æˆåŠŸæ¸…ç©ºï¼');
        });
      };

      // --- åŒ¯å‡º Markdown æ–‡å­— ---
      const openMdModal = (tab) => {
        let md = '';
        if (tab === 'SUMMARY') {
          md += `### ç©ºæ©Ÿé»ç­çµ±è¨ˆç¸½è¡¨\n`;
          md += `*çµ±è¨ˆæ™‚é–“ï¼š${currentTimeStr}*\n\n`;
          md += `| ç©ºæ©Ÿçµ±è¨ˆ | ${AREAS.join(' | ')} |\n`;
          md += `| :--- | ${AREAS.map(() => ':---:').join(' | ')} |\n`;

          ITEMS.forEach(item => {
            const rowValues = AREAS.map(area => inventory[area][item.id] || 'N/A');
            md += `| **${item.name}** | ${rowValues.join(' | ')} |\n`;
          });
        } else {
          md += `### ${tab} ç©ºæ©Ÿé»ç­ç´€éŒ„\n`;
          md += `*çµ±è¨ˆæ™‚é–“ï¼š${currentTimeStr}*\n\n`;
          const validItems = ITEMS.filter(item => item.validAreas.includes(tab));
          validItems.forEach(item => {
            md += `- **${item.name}**: ${inventory[tab][item.id]}\n`;
          });
        }
        
        setMdModal({ isOpen: true, content: md, title: tab === 'SUMMARY' ? 'çµ±è¨ˆç¸½è¡¨' : `${tab} å€` });
      };

      const copyMarkdownToClipboard = () => {
        const textArea = document.createElement("textarea");
        textArea.value = mdModal.content;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showAlert('å·²æˆåŠŸè¤‡è£½ Markdown æ–‡å­—åˆ°å‰ªè²¼ç°¿ï¼å¯ä»¥å»è²¼ä¸Šå›‰ã€‚');
        } catch (err) {
          showAlert('è¤‡è£½å¤±æ•—ï¼Œè«‹åœ¨æ–‡å­—æ–¹å¡Šä¸­æ‰‹å‹•å…¨é¸ä¸¦è¤‡è£½ã€‚');
        }
        document.body.removeChild(textArea);
      };

      const exportAsImage = async () => {
        if (!window.html2canvas) {
          showAlert('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
          return;
        }
        
        setIsExporting(true);
        try {
          const canvas = await window.html2canvas(tableRef.current, {
            scale: 2.5, // æé«˜åŒ¯å‡ºç•«è³ª
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false
          });
          
          const image = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.href = image;
          const d = new Date();
          const dateString = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥_${d.getHours()}æ™‚${d.getMinutes()}åˆ†`;
          link.download = `ç©ºæ©Ÿé»ç­çµ±è¨ˆ_${dateString}.png`;
          link.click();
        } catch (err) {
          console.error('åŒ¯å‡ºå¤±æ•—:', err);
          showAlert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
        } finally {
          setIsExporting(false);
        }
      };

      // è¨ˆç®—è¡¨æ ¼çš„åˆä½µå„²å­˜æ ¼ (RowSpan) é‚è¼¯
      const getCellSpans = () => {
        const spans = {};
        AREAS.forEach(area => {
          spans[area] = {};
          let i = 0;
          while (i < ITEMS.length) {
            const item = ITEMS[i];
            const val = inventory[area]?.[item.id] || 'N/A';
            
            // å¦‚æœæ˜¯ N/A ä¸”ä¸æ˜¯å‰å…©åˆ— (POç³»åˆ—ä¸åˆä½µ)ï¼Œå‰‡é–‹å§‹å‘ä¸‹å°‹æ‰¾åˆä½µ
            if (val === 'N/A' && i >= 2) {
              let spanCount = 1;
              let j = i + 1;
              while (j < ITEMS.length && (inventory[area]?.[ITEMS[j].id] === 'N/A')) {
                spanCount++;
                j++;
              }
              spans[area][item.id] = { span: spanCount, skip: false };
              for (let k = i + 1; k < j; k++) {
                spans[area][ITEMS[k].id] = { span: 0, skip: true };
              }
              i = j;
            } else {
              spans[area][item.id] = { span: 1, skip: false };
              i++;
            }
          }
        });
        return spans;
      };

      if (Object.keys(inventory).length === 0) {
        return <div className="p-10 text-center text-slate-500 flex flex-col items-center"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>ç³»çµ±è¼‰å…¥ä¸­...</div>;
      }

      const cellSpans = activeTab === 'SUMMARY' ? getCellSpans() : {};

      return (
        <div className="min-h-screen flex flex-col w-full" onClick={() => setFocusedItem(null)}>
          
          {/* ç³»çµ±æç¤º Modal */}
          {modal.isOpen && (
            <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                <div className="p-5 sm:p-6">
                  <h3 className="text-base sm:text-lg font-bold text-slate-800 mb-2">ç³»çµ±æç¤º</h3>
                  <p className="text-sm sm:text-base text-slate-600">{modal.message}</p>
                </div>
                <div className="bg-slate-50 p-3 sm:p-4 flex justify-end gap-3 border-t border-slate-100">
                  {modal.type === 'confirm' && (
                    <button onClick={closeModal} className="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 font-medium">
                      å–æ¶ˆ
                    </button>
                  )}
                  <button 
                    onClick={() => {
                      if (modal.onConfirm) modal.onConfirm();
                      closeModal();
                    }} 
                    className="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-medium"
                  >
                    ç¢ºå®š
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Markdown åŒ¯å‡º Modal */}
          {mdModal.isOpen && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                <div className="p-4 sm:p-5 border-b border-slate-100 flex justify-between items-center">
                  <h3 className="text-lg font-bold text-slate-800">{mdModal.title} - æ–‡å­—åŒ¯å‡º</h3>
                  <button onClick={() => setMdModal(prev => ({...prev, isOpen: false}))} className="text-slate-400 hover:text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-full p-1 transition-colors">
                    <IconX className="w-5 h-5" />
                  </button>
                </div>
                
                <div className="p-4 sm:p-5 flex-1 overflow-y-auto bg-white">
                  <textarea
                    readOnly
                    value={mdModal.content}
                    className="w-full h-52 sm:h-64 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono text-slate-700 outline-none resize-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 custom-scrollbar mb-3"
                  />
                  
                  {/* æ–°å¢çš„ Markdown ç°¡å–®è§£é‡‹å€å¡Š */}
                  <div className="bg-blue-50/50 border border-blue-100 rounded-lg p-3 sm:p-4 flex gap-2.5 items-start">
                    <IconInfo className="w-5 h-5 text-blue-500 mt-0.5 flex-none" />
                    <div>
                      <p className="text-sm font-bold text-blue-800 mb-1">ğŸ’¡ ä»€éº¼æ˜¯ Markdown æ ¼å¼ï¼Ÿ</p>
                      <p className="text-xs sm:text-sm text-blue-700 leading-relaxed">
                        é€™æ˜¯ä¸€ç¨®åˆ©ç”¨ç°¡å–®ç¬¦è™Ÿ (å¦‚ <code className="bg-blue-100 px-1 rounded">|</code> æˆ– <code className="bg-blue-100 px-1 rounded">-</code>) ä¾†æ’ç‰ˆçš„ç´”æ–‡å­—ã€‚<strong>åªè¦å°‡ä¸Šæ–¹æ–‡å­—ç›´æ¥è¤‡è£½ï¼Œè²¼ä¸Šåˆ°æ”¯æ´çš„ç³»çµ±</strong> (ä¾‹å¦‚äº¤ç­ç³»çµ±ã€Notionã€Slack)ï¼Œç³»çµ±å°±æœƒè‡ªå‹•æŠŠå®ƒè½‰æ›æˆæ¼‚äº®çš„ã€Œè¡¨æ ¼ã€æˆ–ã€Œæ¢åˆ—é‡é»ã€å–”ï¼
                      </p>
                    </div>
                  </div>
                </div>

                <div className="bg-slate-50 p-3 sm:p-4 flex justify-end gap-3 border-t border-slate-100">
                  <button onClick={() => setMdModal(prev => ({...prev, isOpen: false}))} className="px-4 py-2 text-sm text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 font-medium">é—œé–‰</button>
                  <button onClick={copyMarkdownToClipboard} className="flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-medium active:scale-95 transition-transform">
                    <IconCopy className="w-4 h-4" /> ä¸€éµè¤‡è£½
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* é ‚éƒ¨å°è¦½åˆ— */}
          <header className="bg-blue-700 text-white shadow-md sticky top-0 z-40 w-full" onClick={e => e.stopPropagation()}>
            <div className="max-w-4xl mx-auto px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center">
              <div className="flex items-center gap-1.5 sm:gap-2">
                <IconClipboard />
                <h1 className="text-base sm:text-lg md:text-xl font-bold tracking-wide">ç©ºæ©Ÿé»ç­</h1>
              </div>
              <button onClick={requestClearData} className="text-blue-200 hover:text-white flex items-center gap-1 text-xs sm:text-sm bg-blue-800 px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-lg transition active:scale-95">
                <IconX />æ¸…ç©º
              </button>
            </div>
            
            {/* æ¨™ç±¤é åˆ‡æ› */}
            <div className="flex overflow-x-auto hide-scrollbar border-t border-blue-600 w-full">
              {AREAS.map(area => (
                <button
                  key={area}
                  onClick={() => { setActiveTab(area); setFocusedItem(null); }}
                  className={`flex-1 py-2.5 sm:py-3 px-2 sm:px-4 min-w-[65px] sm:min-w-[80px] text-sm sm:text-base text-center font-medium border-b-4 transition-colors ${
                    activeTab === area ? 'border-white bg-blue-800 text-white' : 'border-transparent text-blue-200 hover:bg-blue-600'
                  }`}
                >
                  {area}
                </button>
              ))}
              <button
                onClick={() => { setActiveTab('SUMMARY'); setFocusedItem(null); }}
                className={`flex-1 py-2.5 sm:py-3 px-2 sm:px-4 min-w-[85px] sm:min-w-[100px] text-sm sm:text-base text-center font-bold border-b-4 transition-colors ${
                  activeTab === 'SUMMARY' ? 'border-yellow-400 bg-blue-800 text-yellow-400' : 'border-transparent text-blue-200 hover:bg-blue-600'
                }`}
              >
                ç¸½è¡¨é è¦½
              </button>
            </div>
          </header>

          <main className="flex-1 max-w-4xl w-full mx-auto p-2.5 sm:p-4 md:p-6 pb-32">
            
            {/* --- ç·¨è¼¯å€å¡Š --- */}
            {AREAS.includes(activeTab) && (
              <div className="space-y-3 sm:space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                <div className="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center mb-1">
                  <div>
                    <h2 className="text-base sm:text-lg font-bold text-slate-700">å€åŸŸï¼š{activeTab}</h2>
                    {/* é‡å°ã€ŒåŒ¯å‡ºæ–‡å­—ã€æŒ‰éˆ•çš„æ–°å¢å‚™è¨» */}
                    <p className="text-[11px] sm:text-xs text-slate-500 mt-0.5">é»é¸æ¬„ä½å¯ç·¨è¼¯æ•¸é‡ï¼›<strong className="text-blue-600 font-medium">å³å´æŒ‰éˆ•å¯åŒ¯å‡ºç´”æ–‡å­—ï¼Œæ–¹ä¾¿è¤‡è£½äº¤ç­ã€‚</strong></p>
                  </div>
                  <button
                    onClick={(e) => { e.stopPropagation(); openMdModal(activeTab); }}
                    className="flex items-center gap-1 sm:gap-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg text-[13px] sm:text-sm font-medium transition-colors border border-slate-300 active:scale-95 whitespace-nowrap"
                  >
                    <IconFileText className="w-4 h-4" /> 
                    <span className="hidden sm:inline">åŒ¯å‡ºæ–‡å­—</span>
                    <span className="sm:hidden">åŒ¯å‡º</span>
                  </button>
                </div>

                <div className="grid grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4">
                  {ITEMS.filter(item => item.validAreas.includes(activeTab)).map(item => {
                    const isFocused = focusedItem === item.id;
                    const isUnchanged = inventory[activeTab][item.id] === '0';
                    
                    return (
                      <div 
                        key={item.id} 
                        onClick={(e) => { e.stopPropagation(); setFocusedItem(item.id); }}
                        className={`bg-white p-2.5 sm:p-4 rounded-xl border flex flex-col gap-2 transition-all duration-200 ease-in-out cursor-pointer select-none
                          ${isFocused 
                            ? 'scale-[1.03] shadow-lg border-blue-500 ring-2 ring-blue-200 z-10' 
                            : 'scale-100 shadow-sm border-slate-200 hover:border-blue-300'
                          }`}
                      >
                        <div className="flex justify-between items-start pointer-events-none">
                          <label className="font-bold text-[13px] sm:text-base text-slate-800 leading-tight">
                            {item.name}
                          </label>
                          {isUnchanged && (
                            <span className="text-[9px] sm:text-xs font-normal text-slate-400 bg-slate-100 px-1 py-0.5 sm:px-2 sm:py-1 rounded whitespace-nowrap ml-1">
                              æœªç•°å‹•
                            </span>
                          )}
                        </div>
                        
                        <div className="flex gap-1 sm:gap-2 items-center w-full">
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleMainMathChange(activeTab, item.id, -1); }}
                            className={`flex-none w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition-colors ${isFocused ? 'bg-blue-50 text-blue-600 border border-blue-200' : ''}`}
                          >
                            <IconMinus />
                          </button>
                          
                          <input
                            type="text"
                            value={inventory[activeTab][item.id]}
                            onChange={(e) => handleInputChange(activeTab, item.id, e.target.value)}
                            onClick={(e) => { e.stopPropagation(); setFocusedItem(item.id); }}
                            className={`min-w-0 w-full flex-1 text-center text-base sm:text-xl font-bold p-1 sm:p-1.5 h-8 sm:h-10 border rounded-lg outline-none transition-colors 
                              ${isFocused ? 'border-blue-500 bg-blue-50/30' : 'border-slate-300'}`}
                          />
                          
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleMainMathChange(activeTab, item.id, 1); }}
                            className={`flex-none w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition-colors ${isFocused ? 'bg-blue-50 text-blue-600 border border-blue-200' : ''}`}
                          >
                            <IconPlus />
                          </button>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-1 mt-auto w-full">
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleStatusIncrease(activeTab, item.id, 'è«‹ä¿®'); }} 
                            className="col-span-1 py-1.5 bg-red-50 hover:bg-red-100 text-red-700 rounded-md text-[10px] sm:text-xs font-medium transition active:scale-95 border border-red-100 flex items-center justify-center leading-none"
                          >
                            +1(è«‹ä¿®)
                          </button>
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleStatusIncrease(activeTab, item.id, 'è½‰é€'); }} 
                            className="col-span-1 py-1.5 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-md text-[10px] sm:text-xs font-medium transition active:scale-95 border border-orange-100 flex items-center justify-center leading-none"
                          >
                            +1(è½‰é€)
                          </button>
                          <button 
                            onClick={(e) => { e.stopPropagation(); handleResetItem(activeTab, item.id); }} 
                            className="col-span-2 py-1.5 bg-slate-100 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-md text-[11px] sm:text-xs font-medium active:scale-95 transition-colors border border-transparent flex items-center justify-center leading-none"
                          >
                            æ­¸é›¶
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* --- ç¸½è¡¨é è¦½ (åœ–ç‰‡è¼¸å‡ºå€) --- */}
            {activeTab === 'SUMMARY' && (
              <div className="space-y-3 sm:space-y-4 animate-in fade-in zoom-in-95 duration-300" onClick={e => e.stopPropagation()}>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-slate-200">
                  <div>
                    <h2 className="text-base sm:text-lg font-bold text-slate-800">çµ±è¨ˆç¸½è¡¨</h2>
                    {/* é‡å°ã€ŒåŒ¯å‡º MDã€æŒ‰éˆ•çš„æ–°å¢å‚™è¨» */}
                    <p className="text-[11px] sm:text-sm text-slate-500 mt-0.5">å¯é¸æ“‡è¼¸å‡ºåœ–ç‰‡ï¼Œ<strong className="text-blue-600 font-medium">æˆ–åŒ¯å‡º Markdown (MD) æ–‡å­—è¡¨æ ¼</strong></p>
                  </div>
                  
                  <div className="flex flex-row w-full sm:w-auto gap-2">
                    <button 
                      onClick={() => openMdModal('SUMMARY')}
                      className="flex-1 sm:flex-none flex items-center justify-center gap-1.5 bg-slate-700 hover:bg-slate-800 text-white px-3 py-2.5 sm:px-4 sm:py-2 rounded-lg text-sm sm:text-base font-bold shadow-md transition-all active:scale-95"
                    >
                      <IconFileText className="w-4 h-4 sm:w-5 sm:h-5"/> 
                      <span className="whitespace-nowrap">åŒ¯å‡º MD</span>
                    </button>
                    <button 
                      onClick={exportAsImage}
                      disabled={isExporting}
                      className="flex-1 sm:flex-none flex items-center justify-center gap-1.5 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2.5 sm:px-4 sm:py-2 rounded-lg text-sm sm:text-base font-bold shadow-md shadow-emerald-600/20 transition-all disabled:opacity-70 active:scale-95"
                    >
                      {isExporting ? 'ç”Ÿæˆä¸­...' : <><IconCamera className="w-4 h-4 sm:w-5 sm:h-5" /> <span className="whitespace-nowrap">å„²å­˜åœ–ç‰‡</span></>}
                    </button>
                  </div>
                </div>

                <div className="w-full max-w-[calc(100vw-1.2rem)] sm:max-w-full overflow-x-auto bg-white p-2 sm:p-4 rounded-xl shadow-sm border border-slate-200 custom-scrollbar">
                  
                  {/* === å³å°‡è¢«åŒ¯å‡ºç‚ºåœ–ç‰‡çš„ç¯„åœ === */}
                  <div ref={tableRef} className="bg-white p-4 min-w-[650px] report-table">
                    
                    {/* è¡¨é ­æ™‚é–“èˆ‡æ¨™é¡Œ */}
                    <div className="flex justify-between items-end mb-2 pb-1">
                      <h2 className="text-xl font-bold text-black m-0 tracking-wider">ç©ºæ©Ÿé»ç­çµ±è¨ˆè¡¨</h2>
                      <div className="text-sm font-bold text-black bg-slate-100 px-3 py-1 rounded-sm border border-slate-300">
                        çµ±è¨ˆæ™‚é–“ï¼š{currentTimeStr}
                      </div>
                    </div>
                    
                    {/* åš´æ ¼çš„ Excel æ ¼å¼è¡¨æ ¼ */}
                    <table style={{ borderCollapse: 'collapse', width: '100%', color: '#000000', border: '1px solid black' }}>
                      <thead>
                        <tr>
                          <th style={{ border: '1px solid black', padding: '6px 8px', backgroundColor: '#ffffff', fontWeight: 'bold' }}>ç©ºæ©Ÿçµ±è¨ˆ</th>
                          {AREAS.map(area => (
                            <th key={area} style={{ border: '1px solid black', padding: '6px 8px', backgroundColor: '#ffffff', fontWeight: 'bold' }}>{area}</th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {ITEMS.map((item, idx) => (
                          <tr key={item.id}>
                            <td style={{ 
                              border: '1px solid black', 
                              padding: '6px 8px', 
                              textAlign: 'left',
                              backgroundColor: item.isYellow ? '#FFC000' : '#ffffff' 
                            }}>
                              {item.name}
                            </td>
                            {AREAS.map(area => {
                              const spanInfo = cellSpans[area]?.[item.id] || { span: 1, skip: false };
                              
                              // å¦‚æœæ­¤æ ¼è¢«ä¸Šæ–¹åˆä½µï¼Œå‰‡ä¸æ¸²æŸ“
                              if (spanInfo.skip) return null;

                              const val = inventory[area]?.[item.id];
                              const isNA = val === 'N/A';
                              
                              return (
                                <td 
                                  key={`${area}-${item.id}`} 
                                  rowSpan={spanInfo.span}
                                  style={{ 
                                    border: '1px solid black', 
                                    padding: '6px 8px', 
                                    textAlign: 'center',
                                    verticalAlign: 'middle',
                                    backgroundColor: isNA ? '#D9D9D9' : '#ffffff',
                                    fontWeight: isNA ? 'normal' : 'bold'
                                  }}
                                >
                                  {val}
                                </td>
                              );
                            })}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  {/* === åœ–ç‰‡ç¯„åœçµæŸ === */}

                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
