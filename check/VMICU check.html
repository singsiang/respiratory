<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¤œè£œç‰©æ–™ Check list</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ QRious ç”Ÿæˆ QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- è¨­å®š Tailwind çš„æ·±è‰²æ¨¡å¼ç‚º class æ¨¡å¼ -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        teal: { 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488' }
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªè¨‚æ²è»¸èˆ‡éš±è—ä¸éœ€è¦çš„é è¨­æ¨£å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .transition-colors { transition-duration: 200ms; }
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ï¼Œè®“ä»‹é¢æ›´ç°¡æ½” */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* é¿å…é•·å–®å­—æ’ç ´ç‰ˆé¢ */
        .break-words { word-break: break-word; overflow-wrap: break-word; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors font-sans pb-24 overflow-x-hidden w-full">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-10 transition-colors">
        <div class="max-w-5xl mx-auto px-3 sm:px-4 py-3 sm:py-4">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h1 class="text-lg sm:text-xl md:text-2xl font-bold flex items-center gap-1 sm:gap-2 text-teal-600 dark:text-teal-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    å¤§å¤œè£œç‰©æ–™ Check list
                </h1>
                <button id="theme-toggle" class="p-2 rounded-full shrink-0 bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-yellow-300 hover:opacity-80 transition-opacity" title="åˆ‡æ›æ·±æ·ºè‰²">
                    <!-- é è¨­é¡¯ç¤ºæœˆäº® (æ·ºè‰²æ¨¡å¼æ™‚) -->
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </button>
            </div>

            <!-- é€²åº¦æ¢ -->
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="flex-1 h-2 rounded-full overflow-hidden bg-slate-200 dark:bg-slate-700">
                    <div id="progress-bar" class="h-full bg-teal-500 transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <span id="progress-text" class="text-xs sm:text-sm font-medium whitespace-nowrap">
                    0 / 0 (0%)
                </span>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <main class="max-w-5xl mx-auto px-2 sm:px-4 py-4 sm:py-6 w-full box-border">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            <!-- å·¦æ¬„ -->
            <div id="col-left" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-3 sm:p-4 md:p-6 transition-colors w-full box-border overflow-hidden"></div>
            <!-- å³æ¬„ -->
            <div id="col-right" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-3 sm:p-4 md:p-6 transition-colors w-full box-border overflow-hidden"></div>
        </div>
    </main>

    <!-- åº•éƒ¨æµ®å‹•æ“ä½œåˆ— -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transition-colors z-20">
        <div class="max-w-5xl mx-auto px-2 sm:px-4 py-2 sm:py-3 flex justify-between items-center gap-2 sm:gap-4 w-full box-border">
            <button id="reset-btn" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 p-2 sm:px-4 sm:py-3 rounded-lg font-medium transition-colors flex-1 bg-red-50 text-red-600 hover:bg-red-100 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-slate-600 text-xs sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                <span>é‡ç½®</span>
            </button>

            <button id="qr-btn" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 p-2 sm:px-4 sm:py-3 rounded-lg font-medium transition-colors flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-slate-700 dark:text-blue-400 dark:hover:bg-slate-600 text-xs sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><rect x="7" y="7" width="3" height="3"/><rect x="14" y="7" width="3" height="3"/><rect x="7" y="14" width="3" height="3"/><path d="M14 14h.01"/><path d="M17 14h.01"/><path d="M14 17h.01"/><path d="M17 17h.01"/></svg>
                <span>QRç¢¼</span>
            </button>

            <button id="copy-btn" class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 p-2 sm:px-6 sm:py-3 rounded-lg font-medium text-white transition-all flex-[1.5] sm:flex-[2] bg-teal-600 hover:bg-teal-700 text-xs sm:text-base">
                <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                <span id="copy-text" class="whitespace-nowrap">è¤‡è£½å ±å‘Š</span>
            </button>
        </div>
    </footer>

    <!-- QR Code å½ˆå‡ºè¦–çª— -->
    <div id="qr-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity opacity-0 px-4">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl max-w-sm w-full transform transition-all scale-95 duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">äº¤ç­å ±å‘Š QR Code</h3>
                <button id="close-qr-btn" class="p-1 rounded-md text-slate-500 hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="bg-white p-4 rounded-xl flex justify-center items-center mb-4 border border-slate-200 shadow-inner">
                <canvas id="qr-canvas"></canvas>
            </div>
            <p class="text-sm text-center text-slate-500 dark:text-slate-400">è«‹æ¥ç­åŒä»æƒææ­¤æ¢ç¢¼ä»¥è®€å–äº¤ç­æ¸…å–®</p>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // SVG åœ–ç¤ºå­—ä¸²
        const iconSquare = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 dark:text-slate-500 group-hover:text-teal-400 transition-colors shrink-0"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>`;
        const iconCheckSquare = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-500 dark:text-teal-400 scale-110 transition-transform shrink-0"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`;
        const iconCopy = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        const iconCheckCircle = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;

        // è³‡æ–™çµæ§‹
        const leftColData = [
            [{ id: 'a', label: 'A' }, { id: 'b', label: 'B' }, { id: 'c', label: 'C' }],
            [{ id: 'hs', label: 'H/S' }],
            [{ id: 'glove', label: 'æ‰‹å¥—' }, { id: 'tissue', label: 'è¡›ç”Ÿç´™' }, { id: 'paper_towel', label: 'æ“¦æ‰‹ç´™' }],
            [{ id: 'gauze', label: 'ç´—å¸ƒ' }, { id: 'wrap', label: 'ä¿é®®è†œ' }],
            [{ id: 'dish_soap', label: 'æ´—ç¢—ç²¾' }, { id: 'alcohol', label: 'é…’ç²¾' }, { id: 'hand_soap', label: 'æ´—æ‰‹ä¹³' }],
            [{ id: 'waste_bucket', label: 'å»¢æ°´æ¡¶' }, { id: 'syringe_box', label: 'é‡ç­’æ”¶é›†ç›’' }],
            [{ id: 'kidney_dish', label: 'å½ç›†' }, { id: 'hepa', label: 'HEPA' }, { id: 'double_tube', label: 'é›™é ­ç®¡' }],
            [{ id: 'empty_syringe', label: 'ç©ºé‡' }, { id: 'small_parts', label: 'å°é›¶ä»¶' }],
            [{ id: 'nc', label: 'NC' }, { id: 'sm', label: 'SM' }, { id: 'nrm', label: 'NRM' }],
            [{ id: 'mf', label: 'MF' }, { id: 'corrugated_tube', label: 'è›‡è¡Œç®¡' }, { id: 'bh', label: 'BH' }],
            [{ label: 'Aerosol mask', isLabelOnly: true }, { id: 'aero_l', label: '(L)' }, { id: 'aero_m', label: '(M)' }, { id: 'aero_p', label: '(å…’)' }],
            [{ id: 'venturi', label: 'Venturi mask' }],
            [{ id: 'tr_o2', label: 'Tr. O2' }, { id: 'tr_mask', label: 'Tr. Mask.' }, { id: 't_piece', label: 'T-piece' }],
            [{ id: 'hn', label: 'HN' }, { id: 'an', label: 'AN' }],
            [{ id: 'hf_nasal', label: 'HF nasal prong å…©å¥—' }],
            [{ label: 'Aerochamber.', isLabelOnly: true }, { id: 'aerochamber_mask', label: '(mask*2)' }, { id: 'aerochamber_mv', label: '(MV*2)' }],
            [{ isIndent: true }, { id: 'aerochamber_tr', label: '(Tr*1)' }, { id: 'aerochamber_oral', label: '(Oral*1)' }],
            [{ id: 'pocket_air', label: 'Pocket Air ä¸€çµ„' }, { id: 'pfm', label: 'PFM ä¸€çµ„' }]
        ];

        const rightColData = [
            [{ label: 'BiPAP mask', isLabelOnly: true }, { id: 'bipap_l', label: '(L)' }, { id: 'bipap_m', label: '(M)' }, { id: 'bipap_s', label: '(S)' }, { label: 'å„å…©å¥—', isLabelOnly: true }],
            [{ label: 'Nasal mask', isLabelOnly: true }, { id: 'nasal_l', label: '(L)' }, { id: 'nasal_m', label: '(M)' }, { id: 'nasal_s', label: '(S)' }],
            [{ id: 'n95', label: 'N95 mask' }],
            [{ id: 'temp_probe', label: 'æ„Ÿæº«ç·š' }, { id: 'etco2', label: 'EtCO2 æ¥é ­' }],
            [{ label: 'åæ°£é–¥', isLabelOnly: true }, { id: 'exhale_savina', label: '(savina)' }, { id: 'exhale_evita4', label: '(Evita4)' }],
            [{ id: 'flow_sensor', label: 'Flow sensor' }, { id: 'pulse_ox', label: 'Pulse oximeter(å‚™å“)' }],
            [{ id: 'tb_filter', label: 'TB filter ä¸€å¥—' }],
            [{ id: 'nippv_tube', label: 'NIPPV tube' }],
            [{ id: 'ippb_tube', label: 'IPPB tube' }],
            [{ id: 'simple_tube', label: 'ç°¡æ˜“ tube' }],
            [{ id: 'water_tube', label: 'åŠ æ°´ tube' }, { id: 'cascade', label: 'Cascade' }],
            [{ id: 'triflo', label: 'Triflo (*1)' }],
            [{ id: 'a4_paper', label: 'A4 ç´™' }, { id: 'billing_form', label: 'è¨ˆåƒ¹å–®' }],
            [{ id: 'stationery', label: 'æ–‡å…·(è¨‚æ›¸é‡, è† å¸¶, å¥‡ç•°ç­†..)' }],
            [{ id: 'water_bag_alert', label: 'æ°´è¢‹å¿«æ²’ï¼Œé€šçŸ¥æ·‘å¨Ÿå­¸å§Š', highlight: 'yellow' }],
            [{ id: 'other', label: 'å…¶ä»–:', hasInput: true }],
            [{ id: 'end_month_ambu', label: 'æœˆåº• Ambu *5 mask*5 Adapter*5 PEEP valve*1 (æœˆåº•å¯„å›åŠè£œæ–°)', highlight: 'red' }]
        ];

        // ç‹€æ…‹ç®¡ç†
        let state = {
            checks: JSON.parse(localStorage.getItem('nightShiftChecks')) || {},
            quantities: JSON.parse(localStorage.getItem('nightShiftQuantities')) || {},
            otherText: localStorage.getItem('nightShiftOtherText') || '',
            theme: localStorage.getItem('nightShiftTheme') || 'light'
        };

        const allIds = [...leftColData, ...rightColData].flat().filter(i => i.id).map(i => i.id);

        // åˆå§‹åŒ–
        function init() {
            applyTheme();
            renderColumn(document.getElementById('col-left'), leftColData);
            renderColumn(document.getElementById('col-right'), rightColData);
            updateProgress();

            // äº‹ä»¶ç¶å®š
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('reset-btn').addEventListener('click', resetChecks);
            document.getElementById('copy-btn').addEventListener('click', copyReport);
            document.getElementById('qr-btn').addEventListener('click', showQRCode);
            document.getElementById('close-qr-btn').addEventListener('click', closeQRCode);
            
            // é»æ“ŠèƒŒæ™¯é—œé–‰ QR Modal
            document.getElementById('qr-modal').addEventListener('click', (e) => {
                if (e.target.id === 'qr-modal') closeQRCode();
            });
        }

        // æ¸²æŸ“æ¬„ä½
        function updateQty(id, val) {
            state.quantities[id] = val;
            saveState();
        }

        function renderColumn(container, data) {
            let html = '';
            data.forEach(row => {
                const isIndent = row[0]?.isIndent;
                const items = isIndent ? row.slice(1) : row;
                
                // RWDèª¿æ•´ï¼šç¸®å°é–“è·(gap-x-2)èˆ‡ç¸®æ’(ml-3)
                html += `<div class="flex flex-wrap items-center gap-x-2 sm:gap-x-4 gap-y-2 sm:gap-y-3 py-2 border-b last:border-0 border-slate-200 dark:border-slate-700 ${isIndent ? 'ml-3 sm:ml-8' : ''} w-full">`;
                
                items.forEach(item => {
                    if (item.isLabelOnly) {
                        html += `<span class="font-medium text-sm sm:text-base whitespace-nowrap">${item.label}</span>`;
                        return;
                    }

                    const isChecked = !!state.checks[item.id];
                    let highlightClass = '';
                    if (item.highlight === 'yellow') highlightClass = 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/30 dark:border-yellow-700/50';
                    if (item.highlight === 'red') highlightClass = 'bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-700/50';

                    // RWDèª¿æ•´ï¼šè®“æ¯å€‹é …ç›®å…§éƒ¨å¯ä»¥åœ¨å°è¢å¹•æ›è¡Œï¼Œæ–‡å­—è¨­å®š break-words
                    html += `
                        <div class="flex flex-wrap sm:flex-nowrap items-center gap-1 sm:gap-2 cursor-pointer group ${item.highlight ? `p-2 rounded border ${highlightClass} w-full` : ''}" onclick="toggleCheck('${item.id}')">
                            <div class="flex items-center gap-1 sm:gap-2">
                                <div class="relative flex items-center justify-center icon-container" id="icon-${item.id}">
                                    ${isChecked ? iconCheckSquare : iconSquare}
                                </div>
                                <span id="label-${item.id}" class="select-none text-sm sm:text-base break-words ${isChecked ? 'text-slate-500 dark:text-slate-400' : ''} ${item.highlight ? 'font-medium' : ''}">${item.label}</span>
                            </div>
                            
                            <!-- è£œå……æ•¸é‡è¼¸å…¥æ¡† -->
                            <div class="flex items-center ml-1 sm:ml-0 shrink-0" onclick="event.stopPropagation()">
                                <span class="text-xs text-slate-400 dark:text-slate-500 mr-1 select-none">è£œ:</span>
                                <input type="number" min="0" id="qty-${item.id}" value="${state.quantities[item.id] || ''}" oninput="updateQty('${item.id}', this.value)" class="w-10 sm:w-12 px-1 py-0.5 text-center text-sm rounded border outline-none transition-colors shadow-sm bg-white border-slate-300 focus:border-teal-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:border-teal-400" placeholder="0">
                            </div>

                            <!-- æ–‡å­—è¼¸å…¥æ¡†ï¼šå°è¢å¹•è‡ªå‹•æ›è¡Œä¸¦å¡«æ»¿ -->
                            ${item.hasInput ? `<div class="w-full sm:w-auto flex-1 mt-1 sm:mt-0"><input type="text" id="input-${item.id}" value="${state.otherText}" oninput="updateOtherText(this.value)" onclick="event.stopPropagation()" class="w-full px-2 sm:px-3 py-1 text-sm sm:text-base rounded-md border outline-none transition-colors bg-white border-slate-300 focus:border-teal-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:border-teal-400" placeholder="è¼¸å…¥äº‹é …..."></div>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }
        
        // æ›´æ–°å…¶ä»–æ–‡å­—
        function updateOtherText(val) {
            state.otherText = val;
            saveState();
        }

        // åˆ‡æ›æ‰“å‹¾ç‹€æ…‹
        function toggleCheck(id) {
            state.checks[id] = !state.checks[id];
            saveState();
            
            // å±€éƒ¨æ›´æ–° UI
            const iconContainer = document.getElementById(`icon-${id}`);
            const labelEl = document.getElementById(`label-${id}`);
            const isChecked = state.checks[id];
            
            if (iconContainer) iconContainer.innerHTML = isChecked ? iconCheckSquare : iconSquare;
            if (labelEl) {
                if (isChecked) {
                    labelEl.classList.add('text-slate-500', 'dark:text-slate-400');
                } else {
                    labelEl.classList.remove('text-slate-500', 'dark:text-slate-400');
                }
            }
            updateProgress();
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress() {
            const checkedCount = allIds.filter(id => state.checks[id]).length;
            const total = allIds.length;
            const percent = Math.round((checkedCount / total) * 100) || 0;
            
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${checkedCount} / ${total} (${percent}%)`;
        }

        // å­˜æª”æ©Ÿåˆ¶
        function saveState() {
            localStorage.setItem('nightShiftChecks', JSON.stringify(state.checks));
            localStorage.setItem('nightShiftQuantities', JSON.stringify(state.quantities));
            localStorage.setItem('nightShiftOtherText', state.otherText);
            localStorage.setItem('nightShiftTheme', state.theme);
        }

        // é‡ç½®é»ç­
        function resetChecks() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å‹¾é¸ç´€éŒ„èˆ‡æ•¸é‡ï¼Œé–‹å§‹æ–°çš„ç­åˆ¥å—ï¼Ÿ')) {
                state.checks = {};
                state.quantities = {};
                state.otherText = '';
                saveState();
                init(); // é‡ç¹ªUI
            }
        }

        // ä¸»é¡Œåˆ‡æ›
        function applyTheme() {
            const htmlClass = document.documentElement.classList;
            const themeIcon = document.getElementById('theme-icon');
            
            if (state.theme === 'dark') {
                htmlClass.add('dark');
                htmlClass.remove('light');
                themeIcon.outerHTML = `<svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
            } else {
                htmlClass.add('light');
                htmlClass.remove('dark');
                themeIcon.outerHTML = `<svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            saveState();
            applyTheme();
        }

        // çµ±ä¸€å–å¾—å ±å‘Šå­—ä¸² (ä¾›è¤‡è£½èˆ‡ QR Code ä½¿ç”¨)
        function getReportString() {
            let checkedCount = 0;
            let uncheckedItems = [];
            let restockItems = []; // éœ€è£œæ•¸é‡çš„æ¸…å–®

            const processItem = (item) => {
                if (!item.id) return;
                let name = item.label;
                if (item.id.startsWith('aero_')) name = `Aerosol mask ${item.label}`;
                else if (item.id.startsWith('bipap_')) name = `BiPAP mask ${item.label}`;
                else if (item.id.startsWith('nasal_')) name = `Nasal mask ${item.label}`;
                else if (item.id.startsWith('exhale_')) name = `åæ°£é–¥ ${item.label}`;
                else if (item.id.startsWith('aerochamber_')) name = `Aerochamber ${item.label}`;

                // æª¢æŸ¥æ˜¯å¦æ‰“å‹¾
                if (state.checks[item.id]) {
                    checkedCount++;
                } else {
                    uncheckedItems.push(name);
                }

                // æª¢æŸ¥æ˜¯å¦å¡«å¯«äº†éœ€è£œå……æ•¸é‡
                const qty = parseInt(state.quantities[item.id]);
                if (qty > 0) {
                    restockItems.push(`${name} x${qty}`);
                }
            };

            [...leftColData, ...rightColData].flat().forEach(processItem);

            const now = new Date();
            const dateStr = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            let report = `ã€å¤§å¤œè£œç‰©æ–™äº¤ç­å ±å‘Š ${dateStr}ã€‘\n\n`;
            
            if (restockItems.length > 0) {
                report += `ğŸ“¦ éœ€è£œå……ç‰©æ–™æ¸…å–®:\n${restockItems.join('\n')}\n\n`;
            } else {
                report += `ğŸ“¦ éœ€è£œå……ç‰©æ–™æ¸…å–®: ç„¡\n\n`;
            }

            report += `âŒ æœªé»æ¸…/å¾…æŸ¥é …ç›® (${uncheckedItems.length}):\n${uncheckedItems.length > 0 ? uncheckedItems.join('ã€') : 'ç„¡'}\n\n`;
            report += `âœ… å·²é»æ¸…é …ç›®: ${checkedCount} é …\n`;

            if (state.checks['other'] || state.otherText) {
                report += `ğŸ“ å…¶ä»–å‚™è¨»: ${state.otherText || '(æœ‰æ‰“å‹¾ä½†æœªå¡«å¯«)'}\n`;
            }

            return report;
        }

        // ç”¢ç”Ÿå ±è¡¨èˆ‡è¤‡è£½
        function copyReport() {
            const report = getReportString();

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const btn = document.getElementById('copy-btn');
            const icon = document.getElementById('copy-icon');
            const text = document.getElementById('copy-text');

            navigator.clipboard.writeText(report).then(() => {
                showCopiedState();
            }).catch(() => {
                // Fallback for mobile
                const textArea = document.createElement("textarea");
                textArea.value = report;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopiedState();
                } catch (err) {
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½');
                }
                document.body.removeChild(textArea);
            });

            function showCopiedState() {
                btn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
                icon.outerHTML = iconCheckCircle;
                text.innerText = 'å·²è¤‡è£½å ±å‘Šï¼';
                
                setTimeout(() => {
                    btn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    document.getElementById('copy-btn').querySelector('svg').outerHTML = iconCopy;
                    text.innerText = 'è¤‡è£½å ±å‘Š';
                }, 2000);
            }
        }

        // é¡¯ç¤º QR Code å½ˆå‡ºè¦–çª—
        function showQRCode() {
            const report = getReportString();
            
            // ä½¿ç”¨ QRious ç”¢ç”Ÿ QR Code
            new QRious({
                element: document.getElementById('qr-canvas'),
                value: report,
                size: 240, // è¨­å®šé©ç•¶å¤§å°
                level: 'L', // éŒ¯èª¤å®¹å¿åº¦ (L å®¹ç´æœ€å¤šå­—å…ƒ)
                background: 'white',
                foreground: 'black'
            });

            // é¡¯ç¤ºå‹•ç•«èˆ‡è¦–çª—
            const modal = document.getElementById('qr-modal');
            const modalContent = modal.querySelector('div');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // è§¸ç™¼é‡ç¹ªä»¥æ‡‰ç”¨è½‰å ´å‹•ç•«
            void modal.offsetWidth;
            
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }

        // é—œé–‰ QR Code å½ˆå‡ºè¦–çª—
        function closeQRCode() {
            const modal = document.getElementById('qr-modal');
            const modalContent = modal.querySelector('div');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200); // ç­‰å¾…è½‰å ´å‹•ç•«çµæŸ
        }

        // å•Ÿå‹•æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
